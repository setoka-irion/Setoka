<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">

<head>
	<meta charset="utf-8">
	<style>
		#place_list li {
			cursor: pointer; /* 마우스 손가락 모양으로 변경 */
			padding: 4px;
		}

		#place_list li:hover {
			background-color: #f0f0f0; /* 선택된 느낌 주기 */
		}
	</style>
</head>

<body>
	<h1>반려동물 동반 시설 검색</h1>
	<div id="searchArea">
		<input type="text" id="searchInput" placeholder="도로명 주소를 입력하세요" />
		<button id="searchButton">검색</button>
	</div>
	<div id="map" style="width:500px;height:400px;"></div>

	<ul id="place_list"></ul>

	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e26120ed0bcad24a3c2e42608e569c10&libraries=services"></script>
	<script>
		const API_KEY = "XHC41TNS500y6frF0TuMqYySvFKQL6hse4IAH4hvUiCQKZwN3CAtfQcSzmNIOOcPpDJRG%2B6egChnmBDuJt1mIw%3D%3D";
		const BASE_API_URL = `https://api.odcloud.kr/api/15111389/v1/uddi:41944402-8249-4e45-9e9d-a52d0a7db1cc`;
		const totalPages = 5;

		let allItems = [];
		let markers = [];
		let map, geocoder; //주소->위도경도 바꾸는 객체

		//지도 생성
		function makeMap() {
			const mapContainer = document.getElementById('map');
			const mapOption = {
				center: new kakao.maps.LatLng(37.5665, 126.9780),//중심 위도 경도
				level: 3
			};
			map = new kakao.maps.Map(mapContainer, mapOption);
			geocoder = new kakao.maps.services.Geocoder();
		}

		//마커 표시
		function displayMarker(address, callback) {
			geocoder.addressSearch(address, function (result, status) {
				if (status === kakao.maps.services.Status.OK) {
					var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
					var marker = new kakao.maps.Marker({
						map: map, position: coords
					});
					markers.push(marker);

					var infowindow = new kakao.maps.InfoWindow({
						content: `<div style="width:150px;text-align:center;padding:6px 0;">${address}</div>`
					});
					infowindow.open(map, marker);

					if (callback) {
						callback(coords);
					}

				}
			});
		}
		//목록 필터링 후 지도 마커 표시
		async function filter(keyword) {
			const place_list = document.getElementById("place_list");
			place_list.innerHTML = ""; //기존 표시항목 지움

			clearMarker(); //기존 마커 제거

			const filtered = allItems.filter(function (item) {
				const address = item['도로명주소'];
				return address && address.includes(keyword);

			});
			if (filtered.length == 0) {
				place_list.textContent = "검색 결과가 없습니다.";
				return;//함수 종료(forEach 실행하지 않음)
			}

			for (let i = 0; i < filtered.length; i++) {
					const item = filtered[i];
					const li = document.createElement("li");
					const address = item['도로명주소'];

					li.textContent = `${item['시설명']} - ${address}`;
					place_list.appendChild(li);

					await new Promise(resolve => {
						setTimeout(resolve, 0.001); // 💡 요청 간 딜레이
					});

					li.addEventListener('click', () => {
						displayMarker(address, coords => map.setCenter(coords));
					});
				}
		}

		//마커 초기화
		function clearMarker() {
			markers.forEach(marker => marker.setMap(null));
			markers = [];
		}

		async function fetchAll() {
			for (let page = 1; page <= totalPages; page++) {
				const url = `${BASE_API_URL}?page=${page}&perPage=300&serviceKey=${API_KEY}`;
				try {
					const response = await fetch(url);
					const data = await response.json();
					allItems.push(...(data.data || []));
				} catch (err) {
					console.error(`페이지 ${page} 에서 오류 발생:`, err);
				}
			}

		}

		window.onload = function () {
			makeMap();
			fetchAll();  // 👉 이걸 꼭 호출해야 전체 데이터를 불러와!

			document.getElementById("searchButton").addEventListener("click", () => {
				const keyword = document.getElementById("searchInput").value.trim();
				filter(keyword);
			});
		};

	</script>
	<div class="buttons-container">
		<button type="button" onclick="location.href='/';">홈으로</button>
	</div>
</body>

</html>