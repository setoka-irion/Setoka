<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">

<head>
	<meta charset="utf-8">
	<style>
		#place_list li {
			cursor: pointer; /* ë§ˆìš°ìŠ¤ ì†ê°€ë½ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½ */
			padding: 4px;
		}

		#place_list li:hover {
			background-color: #f0f0f0; /* ì„ íƒëœ ëŠë‚Œ ì£¼ê¸° */
		}
	</style>
</head>

<body>
	<h1>ë°˜ë ¤ë™ë¬¼ ë™ë°˜ ì‹œì„¤ ê²€ìƒ‰</h1>
	<div id="searchArea">
		<input type="text" id="searchInput" placeholder="ë„ë¡œëª… ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
		<button id="searchButton">ê²€ìƒ‰</button>
	</div>
	<div id="map" style="width:500px;height:400px;"></div>

	<ul id="place_list"></ul>

	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e26120ed0bcad24a3c2e42608e569c10&libraries=services"></script>
	<script>
		const API_KEY = "XHC41TNS500y6frF0TuMqYySvFKQL6hse4IAH4hvUiCQKZwN3CAtfQcSzmNIOOcPpDJRG%2B6egChnmBDuJt1mIw%3D%3D";
		const BASE_API_URL = `https://api.odcloud.kr/api/15111389/v1/uddi:41944402-8249-4e45-9e9d-a52d0a7db1cc`;
		const totalPages = 5;

		let allItems = [];
		let markers = [];
		let map, geocoder; //ì£¼ì†Œ->ìœ„ë„ê²½ë„ ë°”ê¾¸ëŠ” ê°ì²´

		//ì§€ë„ ìƒì„±
		function makeMap() {
			const mapContainer = document.getElementById('map');
			const mapOption = {
				center: new kakao.maps.LatLng(37.5665, 126.9780),//ì¤‘ì‹¬ ìœ„ë„ ê²½ë„
				level: 3
			};
			map = new kakao.maps.Map(mapContainer, mapOption);
			geocoder = new kakao.maps.services.Geocoder();
		}

		//ë§ˆì»¤ í‘œì‹œ
		function displayMarker(address, callback) {
			geocoder.addressSearch(address, function (result, status) {
				if (status === kakao.maps.services.Status.OK) {
					var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
					var marker = new kakao.maps.Marker({
						map: map, position: coords
					});
					markers.push(marker);

					var infowindow = new kakao.maps.InfoWindow({
						content: `<div style="width:150px;text-align:center;padding:6px 0;">${address}</div>`
					});
					infowindow.open(map, marker);

					if (callback) {
						callback(coords);
					}

				}
			});
		}
		//ëª©ë¡ í•„í„°ë§ í›„ ì§€ë„ ë§ˆì»¤ í‘œì‹œ
		async function filter(keyword) {
			const place_list = document.getElementById("place_list");
			place_list.innerHTML = ""; //ê¸°ì¡´ í‘œì‹œí•­ëª© ì§€ì›€

			clearMarker(); //ê¸°ì¡´ ë§ˆì»¤ ì œê±°

			const filtered = allItems.filter(function (item) {
				const address = item['ë„ë¡œëª…ì£¼ì†Œ'];
				return address && address.includes(keyword);

			});
			if (filtered.length == 0) {
				place_list.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
				return;//í•¨ìˆ˜ ì¢…ë£Œ(forEach ì‹¤í–‰í•˜ì§€ ì•ŠìŒ)
			}

			for (let i = 0; i < filtered.length; i++) {
					const item = filtered[i];
					const li = document.createElement("li");
					const address = item['ë„ë¡œëª…ì£¼ì†Œ'];

					li.textContent = `${item['ì‹œì„¤ëª…']} - ${address}`;
					place_list.appendChild(li);

					await new Promise(resolve => {
						setTimeout(resolve, 0.001); // ğŸ’¡ ìš”ì²­ ê°„ ë”œë ˆì´
					});

					li.addEventListener('click', () => {
						displayMarker(address, coords => map.setCenter(coords));
					});
				}
		}

		//ë§ˆì»¤ ì´ˆê¸°í™”
		function clearMarker() {
			markers.forEach(marker => marker.setMap(null));
			markers = [];
		}

		async function fetchAll() {
			for (let page = 1; page <= totalPages; page++) {
				const url = `${BASE_API_URL}?page=${page}&perPage=300&serviceKey=${API_KEY}`;
				try {
					const response = await fetch(url);
					const data = await response.json();
					allItems.push(...(data.data || []));
				} catch (err) {
					console.error(`í˜ì´ì§€ ${page} ì—ì„œ ì˜¤ë¥˜ ë°œìƒ:`, err);
				}
			}

		}

		window.onload = function () {
			makeMap();
			fetchAll();  // ğŸ‘‰ ì´ê±¸ ê¼­ í˜¸ì¶œí•´ì•¼ ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€!

			document.getElementById("searchButton").addEventListener("click", () => {
				const keyword = document.getElementById("searchInput").value.trim();
				filter(keyword);
			});
		};

	</script>
	<div class="buttons-container">
		<button type="button" onclick="location.href='/';">í™ˆìœ¼ë¡œ</button>
	</div>
</body>

</html>