<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">

<head>
	<title>IRI-ON : íšŒì›ê°€ì…</title>
	<link rel="stylesheet" th:href="@{/CSS/header.css}">
	<link rel="stylesheet" th:href="@{/CSS/signUp.css}">
	
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	
</head>

<body>
	<div th:replace="~{header :: siteHeader}"></div>

	<div class="signUp-container">
		<h1>íšŒì›ê°€ì…</h1>
		<form id="signUpForm" th:action="@{/SignUp}" th:object="${Users}" method="post" class="signUp-form">
			<p th:if="${errorMessage}" th:text="${errorMessage}"></p>
			<input type="email" id="email" th:field="*{id}" placeholder="ì´ë©”ì¼ ì•„ì´ë””" required />
			<button type="button" onclick="sendCode()" class="sub-buttons">ì¸ì¦ë²ˆí˜¸ ë³´ë‚´ê¸°</button>
			<div id="codeBox" class="hidden">
				<input type="text" id="code" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" style="flex: 1;">
				<button type="button" onclick="verifyCode()" class="sub-buttons">ì¸ì¦ í™•ì¸</button>
			</div>
			<input type="password" th:field="*{password}" placeholder="ë¹„ë°€ë²ˆí˜¸" required /><br />
			<input type="password" name="passwordCom" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required/> <br/>
			<input type="text" th:field="*{nickName}" placeholder="ë‹‰ë„¤ì„" required /><br />
			<input type="text" th:field="*{realName}" placeholder="ì‹¤ëª…" required /><br />
			<input type="tel" th:field="*{phoneNumber}" 
			placeholder="ì „í™”ë²ˆí˜¸" 
			required 
			pattern="^\d{3}-\d{3,4}-\d{4}$" 
			maxlength="13"
			inputmode="numeric"/><br />

			<button id="sub" class="sub-buttons hidden" type="button" onclick="submitSignUp()">íšŒì›ê°€ì…</button>
		</form>
	</div>
	
</body>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const phoneInput = document.querySelector('[name="phoneNumber"]');

    phoneInput.addEventListener("input", function (e) {
      let value = e.target.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°

      if (value.length <= 3) {
        // 010
        e.target.value = value;
      } else if (value.length <= 7) {
        // 010-1234
        e.target.value = value.slice(0, 3) + '-' + value.slice(3);
      } else if (value.length <= 11) {
        // 010-1234-5678
        e.target.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7);
      } else {
        // ìµœëŒ€ 11ìë¦¬ê¹Œì§€ë§Œ
        e.target.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
      }
    });
  });
</script>
</html>


<script>
	
	const csrfToken = document.querySelector('meta[name="_csrf"]').content;
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
	const headers = new Headers();
			headers.append('Content-Type', 'application/json');
			headers.append(csrfHeader, csrfToken);

	function sendCode() {
		const email = document.getElementById('email').value;
		if (!email.includes('@')) {
			alert('ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
			return;
		}

		
		fetch('/sendSingUpCode', {
			method: 'POST',
			headers: headers,
			body: JSON.stringify({email: email})
		})
			.then(response => response.text().then(text => {
				if (response.ok) {
					alert('ì¸ì¦ë²ˆí˜¸ê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
					document.getElementById('codeBox').style.display = 'flex';
				} else {
					alert(text);
				}
			}));
	}

	function verifyCode() {
		const email = document.getElementById('email').value;
		if (!email.includes('@')) {
			alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹');
			return;
		}
		const code = document.getElementById('code').value;
		if (!code) {
		    alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
		    return;
		}
		
		if (!/^\d+$/.test(code)) {
		       alert('ì¸ì¦ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
		       return;
		}

		fetch('/verifySingUpCode', {
			method: 'POST',
			headers: headers,
			body: JSON.stringify({email: email, code: code})
		})
			.then(response => {
				if (response.ok) {
					alert('ì¸ì¦ë²ˆí˜¸ ë§ìŒ');
					document.getElementById('sub').style.display = 'block';
				}
				else {
					alert('ì¸ì¦ë²ˆí˜¸ í‹€ë¦¼');
				}
			})
	}

</script>

<script>
	function submitSignUp() {
		const form = document.getElementById('signUpForm');
		const formData = new FormData(form);

		// FormDataë¥¼ JSONìœ¼ë¡œ ë³€í™˜ (passwordCom ì œì™¸)
		const jsonObject = {};
		let passwordComValue = null;

		formData.forEach((value, key) => {
			if (key === 'passwordCom') {
				passwordComValue = value; // passwordComì€ ë”°ë¡œ ëºŒ
			} else {
				jsonObject[key] = value;
			}
		});

		// URLì— passwordCom ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€ (ì¸ì½”ë”© ì£¼ì˜)
		const url = '/SignUp?passwordCom=' + encodeURIComponent(passwordComValue);

		fetch(url, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				[csrfHeader]: csrfToken
			},
			body: JSON.stringify(jsonObject)
		})
		.then(res => {
			if (res.ok) {
				alert("ğŸ‰ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
				window.location.href = "/";  // í™ˆí˜ì´ì§€ë¡œ ì´ë™
			} else {
				return res.text().then(text => alert(text));
			}
		})
		.catch(error => {
			console.error(error);
			alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		});
	}

</script>