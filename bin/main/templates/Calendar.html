<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title>달력 메모</title>
<style>
  table { width: 350px; margin: 20px auto; border-collapse: collapse; }
  th, td { border: 1px solid #ccc; width: 14.28%; height: 80px; vertical-align: top; padding: 5px; cursor: pointer; }
  th { background: #eee; }
  .memo-title { font-size: 0.75em; color: #007bff; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
  .nav-buttons { text-align: center; margin: 10px 0; }
  button { margin: 0 10px; padding: 5px 15px; }
  #memoModal { display: none; position: fixed; z-index: 100; left:0; top:0; width: 100%; height: 100%; background: rgba(0,0,0,0.4);}
  #memoModalContent { background: white; margin: 10% auto; padding: 20px; width: 350px; border-radius: 5px; position: relative;}
  #memoModalContent label { display: block; margin-top: 10px; }
  #memoModalContent input[type="text"], #memoModalContent textarea { width: 100%; padding: 5px; margin-top: 5px; }
  #memoModalClose { position: absolute; right: 10px; top: 10px; cursor: pointer; font-weight: bold; font-size: 18px; }
  .blank { background: #f9f9f9; cursor: default; }
</style>
</head>
<body>

<div class="nav-buttons">
  <form th:action="@{/calendar}" method="get" style="display:inline;">
    <input type="hidden" name="year" th:value="${month == 1} ? ${year - 1} : ${year}" />
    <input type="hidden" name="month" th:value="${month == 1} ? 12 : ${month - 1}" />
    <button type="submit">◀ 이전달</button>
  </form>

  <span id="yearMonth" 
        th:attr="data-year=${year}, data-month=${month}"
        th:text="${year} + '년 ' + ${month} + '월'"></span>

  <form th:action="@{/calendar}" method="get" style="display:inline;">
    <input type="hidden" name="year" th:value="${month == 12} ? ${year + 1} : ${year}" />
    <input type="hidden" name="month" th:value="${month == 12} ? 1 : ${month + 1}" />
    <button type="submit">다음달 ▶</button>
  </form>
</div>

<table id="calendar">
  <thead>
    <tr>
      <th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th>
    </tr>
  </thead>
  
  <tbody>
    <tr th:each="weekRow : ${#numbers.sequence(0, weekCount - 1)}">
      <td th:each="dayIdx : ${#numbers.sequence(0,6)}"
          th:classappend="${((weekRow * 7) + dayIdx + 1 - startBlank <= 0 
                           or (weekRow * 7) + dayIdx + 1 - startBlank > lengthOfMonth) ? 'blank' : ''}"
          th:attr="data-date=${(weekRow * 7) + dayIdx + 1 - startBlank > 0 and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth} ?
                       ${year + '-' + (month < 10 ? '0' + month : month) + '-' + (((weekRow * 7) + dayIdx + 1 - startBlank) < 10 ? '0' + ((weekRow * 7) + dayIdx + 1 - startBlank) : ((weekRow * 7) + dayIdx + 1 - startBlank))} : ''">
        
        <span th:if="${(weekRow * 7) + dayIdx + 1 - startBlank > 0 
                     and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth}"
              th:text="${(weekRow * 7) + dayIdx + 1 - startBlank}"></span>

      </td>
    </tr>
  </tbody>
</table>

<!-- 메모 모달 (수정 모달) -->
<div id="memoModal">
  <div id="memoModalContent">
    <span id="memoModalClose">&times;</span>
    <h2 id="modalTitle">메모 작성</h2>

    <form id="memoForm" method="post" th:action="@{/memo/add}">
      
      <input type="hidden" name="userNum" value="1" />
      <input type="hidden" name="animalNum" value="1" />
      
      <input type="hidden" id="memoNum" name="num" value="" />

      <label for="scheduleDate">날짜</label>
      <input type="text" id="scheduleDate" name="scheduleDateStr" readonly />

      <label for="title">제목</label>
      <input type="text" id="title" name="title" required />

      <label for="content">내용</label>
      <textarea id="content" name="content" rows="5" required></textarea>

      <div style="margin-top: 15px;">
        <button type="submit" id="saveBtn">저장</button>
        <!-- 삭제 버튼 제거 -->
      </div>
    </form>
  </div>
</div>

<!-- 상세보기 모달 -->
<div id="memoDetailModal" style="display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4);">
  <div style="background:white; margin:10% auto; padding:20px; width:350px; border-radius:5px; position:relative;">
    <span id="memoDetailClose" style="position:absolute; right:10px; top:10px; cursor:pointer; font-weight:bold; font-size:18px;">&times;</span>
    <h2>메모 상세보기</h2>
    <p><strong>작성일:</strong> <span id="detailDate"></span></p>
    <p><strong>제목:</strong> <span id="detailTitleText"></span></p>
    <p><strong>내용:</strong> <span id="detailContent"></span></p>
    <div style="margin-top: 15px;">
      <button id="detailEditBtn">수정</button>
      <button id="detailDeleteBtn" style="background-color:#f44336; color:#fff;">삭제</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('memoModal');
  const modalClose = document.getElementById('memoModalClose');
  const scheduleDateInput = document.getElementById('scheduleDate');
  const titleInput = document.getElementById('title');
  const contentInput = document.getElementById('content');
  const memoNumInput = document.getElementById('memoNum');
  const memoForm = document.getElementById('memoForm');
  const modalTitle = document.getElementById('modalTitle');
  const saveBtn = document.getElementById('saveBtn');

  // 상세보기 모달 요소
  const detailModal = document.getElementById('memoDetailModal');
  const detailClose = document.getElementById('memoDetailClose');
  const detailDate = document.getElementById('detailDate');
  const detailTitleText = document.getElementById('detailTitleText');
  const detailContent = document.getElementById('detailContent');
  const detailEditBtn = document.getElementById('detailEditBtn');
  const detailDeleteBtn = document.getElementById('detailDeleteBtn');

  const yearMonthSpan = document.getElementById('yearMonth');
  const year = yearMonthSpan.dataset.year;
  const month = yearMonthSpan.dataset.month;

  // 현재 상세보기 중인 메모 번호 저장용
  let currentDetailMemoNum = null;

  // 달력에 메모 제목 출력용 fetch
  fetch(`/memos?year=${year}&month=${month < 10 ? '0' + month : month}`)
    .then(res => res.json())
    .then(memos => {
      memos.forEach(memo => {
        const dateOnly = memo.scheduleDate.split('T')[0];
        const td = document.querySelector(`td[data-date='${dateOnly}']`);
        if(td) {
          const oldTitle = td.querySelector('.memo-title');
          if(oldTitle) oldTitle.remove();

          const span = document.createElement('span');
          span.className = 'memo-title';
          span.textContent = memo.title;
          td.appendChild(span);

          td.dataset.memoNum = memo.num;
        }
      });
    });

  // 달력 날짜 클릭 이벤트
  document.querySelectorAll('#calendar td').forEach(td => {
    td.addEventListener('click', () => {
      const dateStr = td.getAttribute('data-date');
      if (!dateStr) return;

      const memoNum = td.dataset.memoNum;

      if (memoNum) {
        // 상세보기 모달 먼저 보여줌
        fetch(`/memo/detail?memoNum=${memoNum}`)
          .then(res => res.json())
          .then(memo => {
            currentDetailMemoNum = memo.num || memo.memoNum;

            detailDate.textContent = dateStr;
            detailTitleText.textContent = memo.title;
            detailContent.textContent = memo.content;

            // 상세보기 모달 버튼 이벤트
            detailEditBtn.onclick = () => {
              detailModal.style.display = 'none';

              modalTitle.textContent = "메모 수정";
              saveBtn.textContent = "수정";

              memoNumInput.value = currentDetailMemoNum;
              scheduleDateInput.value = dateStr;
              titleInput.value = memo.title;
              contentInput.value = memo.content;

              modal.style.display = "block";
            };

			detailDeleteBtn.onclick = () => {
			  if (confirm("정말 삭제하시겠습니까?")) {
			    const formData = new URLSearchParams();
			    formData.append('num', currentDetailMemoNum);
			    formData.append('year', year);
			    formData.append('month', month);

			    fetch('/memo/delete', {
			      method: 'POST',
			      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			      body: formData.toString()
			    }).then(() => {
			      detailModal.style.display = 'none';
			      location.href = `/calendar?year=${year}&month=${month}`;
			    });
			  }
			};

            detailModal.style.display = 'block';
          });
      } else {
        // 새 작성 모드
        detailModal.style.display = 'none';

        modalTitle.textContent = "메모 작성";
        saveBtn.textContent = "저장";

        memoNumInput.value = '';
        scheduleDateInput.value = dateStr;
        titleInput.value = '';
        contentInput.value = '';

        modal.style.display = "block";
      }
    });
  });

  // 모달 닫기
  modalClose.onclick = () => {
    modal.style.display = "none";
  };

  detailClose.onclick = () => {
    detailModal.style.display = "none";
  };

  window.onclick = e => {
    if (e.target === modal) {
      modal.style.display = "none";
    }
    if (e.target === detailModal) {
      detailModal.style.display = "none";
    }
  };

  // 메모 작성/수정 폼 제출 시 액션 분기
  memoForm.onsubmit = () => {
    if (memoNumInput.value) {
      memoForm.action = '/memo/update';
    } else {
      memoForm.action = '/memo/add';
    }
  };

});
</script>

</body>
</html>
