<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8" />
	<title>ì• ê²¬ ìƒì„¸ë³´ê¸° + ë‹¬ë ¥</title>
	<link rel="stylesheet" th:href="@{/CSS/header.css}">
	<link rel="stylesheet" th:href="@{/CSS/user.css}">
	<link rel="stylesheet" th:href="@{/CSS/modal.css}">
	<link rel="stylesheet" th:href="@{/CSS/calendar.css}">
	<link rel="stylesheet" th:href="@{/CSS/nav-buttons.css}">
	<link rel="stylesheet" th:href="@{/CSS/memo-list.css}">

	<style>
		.memo-title {
			font-size: 0.75em;
			color: #007bff;
			margin-top: 5px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			display: block;
		}


		button {
			margin: 0 10px;
			padding: 5px 15px;
		}

		#memoModal,
		#memoListModal,
		#memoDetailModal {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.4);
		}

		#memoModalContent,
		#memoListModal>div,
		#memoDetailModal>div {
			background: white;
			margin: 10% auto;
			padding: 20px;
			width: 350px;
			border-radius: 5px;
			position: relative;
			max-height: 70vh;
			overflow-y: auto;
		}

		#memoModalContent label,
		#memoModalContent input[type="text"],
		#memoModalContent textarea,
		#memoModalContent select {
			display: block;
			width: 100%;
			margin-top: 10px;
			padding: 5px;
		}

		#memoModalClose,
		#memoListClose,
		#memoDetailClose {
			position: absolute;
			right: 10px;
			top: 10px;
			cursor: pointer;
			font-weight: bold;
			font-size: 18px;
		}

		.blank {
			background: #f9f9f9;
			cursor: default;
		}
	</style>
</head>

<body>
	<div th:replace="~{header :: siteHeader}"></div>

	<!-- ì• ê²¬ ìƒì„¸ì •ë³´ -->
	<h1 th:text="${CurrentAnimal.animalName} + ' ìƒì„¸ì •ë³´'" style="text-align: center;">ì• ê²¬ ì´ë¦„ ìƒì„¸ì •ë³´</h1>

	<div class="animal-card">
		<div class="user-card-left">
			<img th:if="${CurrentAnimal.profilePath != null and CurrentAnimal.profilePath != ''}"
				th:src="@{{filename}(filename=${CurrentAnimal.profilePath})}" alt="í”„ë¡œí•„ ì‚¬ì§„"
				class="profile-image" />

			<p th:if="${CurrentAnimal.profilePath == null or CurrentAnimal.profilePath == ''}">í”„ë¡œí•„ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>

		</div>

		<div class="user-card-right">
			<ul class="user-info-list">
				
				<li><strong>ì´ë¦„</strong> <span th:text="${CurrentAnimal.animalName}">ì´ë¦„</span></li>
				<li><strong>ì¢…</strong> <span th:text="${CurrentAnimal.species}">ì¢…</span></li>
				<li><strong>ë‚˜ì´</strong> <span th:text="${CurrentAnimal.age}">ë‚˜ì´</span></li>
				<li><strong>í•¨ê»˜í•œ ë‚ </strong> <span th:text="${CurrentAnimal.togetherDateLong}">í•¨ê»˜í•œ ë‚ </span></li>
				<li><strong>ì„±ë³„</strong> <span th:text="${CurrentAnimal.gender}">ì„±ë³„</span></li>
			</ul>
			<div class="animal-buttons">
				<button onclick="location.href='/myanimal'">ì• ê²¬ ëª©ë¡ìœ¼ë¡œ</button>
			</div>
		</div>
	</div>



	<!-- ë‹¬ë ¥ ë„¤ë¹„ê²Œì´ì…˜ -->
	<div class="nav-buttons">
		<form th:action="@{/animal/detail}" method="get" style="display:inline;">
			<input type="hidden" name="animalNum" th:value="${CurrentAnimal.num}" />
			<input type="hidden" name="year" th:value="${month == 1} ? ${year - 1} : ${year}" />
			<input type="hidden" name="month" th:value="${month == 1} ? 12 : ${month - 1}" />
			<button type="submit">â—€</button>
		</form>

		<span id="yearMonth" th:attr="data-year=${year}, data-month=${month}"
			th:text="${year} + 'ë…„ ' + ${month} + 'ì›”'"></span>

		<form th:action="@{/animal/detail}" method="get" style="display:inline;">
			<input type="hidden" name="animalNum" th:value="${CurrentAnimal.num}" />
			<input type="hidden" name="year" th:value="${month == 12} ? ${year + 1} : ${year}" />
			<input type="hidden" name="month" th:value="${month == 12} ? 1 : ${month + 1}" />
			<button type="submit">â–¶</button>
		</form>
	</div>

	<!-- ë‹¬ë ¥ í…Œì´ë¸” -->
	<table id="calendar">
		<thead>
			<tr>
				<th>ì¼</th>
				<th>ì›”</th>
				<th>í™”</th>
				<th>ìˆ˜</th>
				<th>ëª©</th>
				<th>ê¸ˆ</th>
				<th>í† </th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="weekRow : ${#numbers.sequence(0, weekCount - 1)}">
				<td th:each="dayIdx : ${#numbers.sequence(0,6)}"
					th:classappend="${((weekRow * 7) + dayIdx + 1 - startBlank <= 0 or (weekRow * 7) + dayIdx + 1 - startBlank > lengthOfMonth) ? 'blank' : ''}"
					th:attr="data-date=${(weekRow * 7) + dayIdx + 1 - startBlank > 0 and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth} ? ${year + '-' + (month < 10 ? '0' + month : month) + '-' + (((weekRow * 7) + dayIdx + 1 - startBlank) < 10 ? '0' + ((weekRow * 7) + dayIdx + 1 - startBlank) : ((weekRow * 7) + dayIdx + 1 - startBlank))} : ''">

					<span
						th:if="${(weekRow * 7) + dayIdx + 1 - startBlank > 0 and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth}"
						th:text="${(weekRow * 7) + dayIdx + 1 - startBlank}"></span>
				</td>
			</tr>
		</tbody>
	</table>

	<!-- ë©”ëª¨ ëª¨ë‹¬ -->
	<div id="memoModal">
		<div id="memoModalContent">
			<span id="memoModalClose">&times;</span>
			<h2 id="modalTitle" class="modal-title">ë©”ëª¨ ì‘ì„±</h2>

			<form id="memoForm" method="post" th:action="@{/memo/add}">

				<input type="hidden" name="userNum" th:value="${userNum}" />
				<!-- ê¸°ì¡´ animalNum íˆë“  í•„ë“œ ì œê±° -->
				<input type="hidden" id="memoNum" name="num" value="" />

				<div class="form-group">
					<label for="scheduleDate">ì‘ì„±ì¼</label>
					<input type="text" id="scheduleDate" name="scheduleDateStr" readonly />
				</div>
				<hr />

				<div class="form-group">
					<label for="animalSelect">ì• ê²¬ ì„ íƒ</label>
					<div id="animalCheckboxContainer"></div>
					<input type="hidden" id="animalNumStr" name="animalNumStr" />
				</div>
				<hr />

				<div class="form-group">
					<label for="title">ì œëª©</label>
					<input type="text" id="title" name="title" required />
				</div>
				<hr />

				<div class="form-group">
					<label for="content">ë‚´ìš©</label>
					<textarea id="content" name="content" rows="5" required></textarea>
				</div>
				<hr />

				<div class="modal-buttons">
					<button type="submit" id="saveBtn" class="btn">ì €ì¥</button>
				</div>
			</form>
		</div>
	</div>

	<!-- ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->

	<div id="memoListModal" class="modal-overlay">
		<div class="modal-content">
			<span id="memoListClose" class="modal-close">&times;</span>
			<h2 class="modal-title">ë©”ëª¨ ë¦¬ìŠ¤íŠ¸</h2>
			<ul id="memoListContainer" style="list-style:none; padding:0; margin:0;"></ul>

			<div class="modal-buttons">
				<button id="memoListAddBtn" class="btn">ë©”ëª¨ ì¶”ê°€</button>
			</div>
		</div>
	</div>
	<!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->

	<div id="memoDetailModal" class="modal-overlay">
		<div class="modal-content">
			<span id="memoDetailClose" class="modal-close">&times;</span>
			<h2 class="modal-title">ë©”ëª¨ ìƒì„¸ë³´ê¸°</h2>

			<div class="detail-row">
				<span class="label">ë‚ ì§œ</span>
				<span id="detailDate" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">ì• ê²¬ ì´ë¦„</span>
				<span id="detailAnimalName" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">ì œëª©</span>
				<span id="detailTitleText" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">ë‚´ìš©</span>
				<div id="detailContent" class="content-box"></div>
			</div>

			<div class="modal-buttons">
				<button id="detailAddBtn" class="btn">ì¶”ê°€</button>
				<button id="detailBackToListBtn" class="btn" style="display: none;">ëª©ë¡</button>
				<button id="detailEditBtn" class="btn">ìˆ˜ì •</button>
				<button id="detailDeleteBtn" class="btn btn-danger">ì‚­ì œ</button>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		const animalNum = /*[[${animalNum}]]*/ 0;
		const userNum = /*[[${userNum}]]*/ 0;
		/*]]>*/
	</script>

	<script>
		let selectedDateStr = null;
		let lastMemoList = [];

		document.addEventListener('DOMContentLoaded', () => {
			const modal = document.getElementById('memoModal');
			const modalClose = document.getElementById('memoModalClose');
			const scheduleDateInput = document.getElementById('scheduleDate');
			const titleInput = document.getElementById('title');
			const contentInput = document.getElementById('content');
			const memoNumInput = document.getElementById('memoNum');
			const memoForm = document.getElementById('memoForm');
			const modalTitle = document.getElementById('modalTitle');
			const saveBtn = document.getElementById('saveBtn');
			const animalCheckboxContainer = document.getElementById('animalCheckboxContainer');

			const detailModal = document.getElementById('memoDetailModal');
			const detailClose = document.getElementById('memoDetailClose');
			const detailDate = document.getElementById('detailDate');
			const detailTitleText = document.getElementById('detailTitleText');
			const detailContent = document.getElementById('detailContent');
			const detailEditBtn = document.getElementById('detailEditBtn');
			const detailDeleteBtn = document.getElementById('detailDeleteBtn');
			const detailAddBtn = document.getElementById('detailAddBtn');
			const detailAnimalName = document.getElementById('detailAnimalName');

			const memoListModal = document.getElementById('memoListModal');
			const memoListClose = document.getElementById('memoListClose');
			const memoListContainer = document.getElementById('memoListContainer');
			const memoListAddBtn = document.getElementById('memoListAddBtn');

			const yearMonthSpan = document.getElementById('yearMonth');
			const year = parseInt(yearMonthSpan.dataset.year);
			const month = parseInt(yearMonthSpan.dataset.month);

			let animalMap = new Map();
			let currentDetailMemoNum = null;

			// âœ… í•´ë‹¹ ì• ê²¬ë§Œ ë“±ë¡


			// 1. ë™ë¬¼ ëª©ë¡ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸°
			fetch(`/animals`)
				.then(res => res.json())
				.then(animals => {
					animals.forEach(animal => {
						animalMap.set(animal.num, animal.animalName);

						const label = document.createElement('label');
						label.style.display = 'block';

						const checkbox = document.createElement('input');
						checkbox.type = 'checkbox';
						checkbox.name = 'animalNum';
						checkbox.value = animal.num;

						label.appendChild(checkbox);
						label.appendChild(document.createTextNode(' ' + animal.animalName));
						animalCheckboxContainer.appendChild(label);
					});

					// âœ… 2. ë™ë¬¼ ë‹¤ ì²˜ë¦¬í•œ ë‹¤ìŒì— ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
					return fetch(`/memos?year=${year}&month=${month < 10 ? '0' + month : month}`);
				})
				.then(res => res.json())
				.then(memos => {
					const filteredMemos = memos.filter(memo => {return memo.intAnimalNum != null && memo.intAnimalNum.includes(Number(animalNum));});
					const memoMap = {};

					filteredMemos.forEach(memo => {
						const dateOnly = memo.scheduleDate.split('T')[0];
						if (!memoMap[dateOnly]) memoMap[dateOnly] = [];

						if (Array.isArray(memo.intAnimalNum)) {
							const names = memo.intAnimalNum.map(num => animalMap.get(num));
							memo.animalName = names.join(', ');
						} else {
							memo.animalName = animalMap.get(memo.intAnimalNum);
						}
						memoMap[dateOnly].push(memo);
					});

					Object.keys(memoMap).forEach(date => {
						const td = document.querySelector(`td[data-date='${date}']`);
						if (td) {
							td.querySelectorAll('.memo-title').forEach(el => el.remove());
							memoMap[date].forEach(m => {
								const span = document.createElement('span');
								span.className = 'memo-title';
								span.textContent = m.title;
								td.appendChild(span);
							});
							td.dataset.memoList = JSON.stringify(memoMap[date]);
						}
					});

					document.querySelectorAll('#calendar td').forEach(td => {
						td.addEventListener('click', () => {
							const dateStr = td.getAttribute('data-date');
							selectedDateStr = dateStr;
							if (!dateStr) return;

							const memoListStr = td.dataset.memoList;
							let memoList = [];

							if (memoListStr) {
								try {
									memoList = JSON.parse(memoListStr);
								} catch (e) {
									console.error('ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ JSON íŒŒì‹± ì‹¤íŒ¨', e);
								}
							}

							if (memoList.length === 0) {
								detailModal.style.display = 'none';
								modalTitle.textContent = "ë©”ëª¨ ì‘ì„±";
								saveBtn.textContent = "ì €ì¥";

								memoNumInput.value = '';
								scheduleDateInput.value = dateStr;
								titleInput.value = '';
								contentInput.value = '';

								modal.style.display = "block";

							} else if (memoList.length === 1) {
								showDetailModal(memoList[0], dateStr);

							} else {
								memoListContainer.innerHTML = '';

								memoList.forEach(memo => {
									const li = document.createElement('li');
									li.style.cursor = 'pointer';
									li.style.padding = '5px 0';
									li.style.borderBottom = '1px solid #ddd';

									li.innerHTML = `
																			<div class="memo-list-item">
																				<div class="memo-title">${memo.title}</div>
																				<div class="memo-animal">ğŸ¾ ${memo.animalName || 'ì• ê²¬ì—†ìŒ'}</div>
																			</div>
																		`;
									li.addEventListener('click', () => {
										memoListModal.style.display = 'none';

										lastMemoList = memoList;

										showDetailModal(memo, dateStr);
									});

									memoListContainer.appendChild(li);
								});

								memoListModal.style.display = 'block';
							}
						});
					});
				});

			function showDetailModal(memo, dateStr) {
				currentDetailMemoNum = memo.num || memo.memoNum;

				detailDate.textContent = dateStr;
				detailTitleText.textContent = memo.title;
				detailContent.textContent = memo.content;
				detailAnimalName.textContent = memo.animalName || 'ì•Œ ìˆ˜ ì—†ìŒ';

				const backToListBtn = document.getElementById('detailBackToListBtn');
				if (lastMemoList.length > 1) {
					backToListBtn.style.display = 'inline-block';
				} else {
					backToListBtn.style.display = 'none';
				}

				backToListBtn.onclick = () => {
					detailModal.style.display = 'none';
					document.getElementById('memoListModal').style.display = 'block';
				};

				detailEditBtn.onclick = () => {
					detailModal.style.display = 'none';
					modalTitle.textContent = "ë©”ëª¨ ìˆ˜ì •";
					saveBtn.textContent = "ìˆ˜ì •";

					memoNumInput.value = currentDetailMemoNum;
					scheduleDateInput.value = dateStr;
					titleInput.value = memo.title;
					contentInput.value = memo.content;
					// ì²´í¬ë°•ìŠ¤ ì„ íƒ ì²˜ë¦¬
					const selectedAnimals = memo.intAnimalNum || memo.animalNum || []; // ë°°ì—´ í˜•íƒœë¼ê³  ê°€ì •

					// ì²´í¬ë°•ìŠ¤ ëª¨ë‘ ì–¸ì²´í¬ í›„,
					animalCheckboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
						cb.checked = selectedAnimals.includes(Number(cb.value));
					});
					modal.style.display = "block";
				};

				detailDeleteBtn.onclick = () => {
					if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
						const formData = new URLSearchParams();
						formData.append('num', currentDetailMemoNum);
						formData.append('year', year);
						formData.append('month', month);

						fetch('/memo/delete', {
							method: 'POST',
							headers: {'Content-Type': 'application/x-www-form-urlencoded'},
							body: formData.toString()
						}).then(() => {
							detailModal.style.display = 'none';
							location.href = `/animal/detail?animalNum=${animalNum}&year=${year}&month=${month}`;
						});
					}
				};

				detailAddBtn.onclick = () => {
					detailModal.style.display = 'none';
					modalTitle.textContent = "ë©”ëª¨ ì‘ì„±";
					saveBtn.textContent = "ì €ì¥";

					memoNumInput.value = '';
					scheduleDateInput.value = dateStr;
					titleInput.value = '';
					contentInput.value = '';
					//					animalSelect.value = '';
					modal.style.display = "block";
				};

				detailModal.style.display = "block";
			}

			modalClose.onclick = () => modal.style.display = "none";
			detailClose.onclick = () => detailModal.style.display = "none";
			memoListClose.onclick = () => memoListModal.style.display = "none";
			memoListAddBtn.onclick = () => {
				memoListModal.style.display = "none";
				modalTitle.textContent = "ë©”ëª¨ ì‘ì„±";
				saveBtn.textContent = "ì €ì¥";
				memoNumInput.value = '';
				scheduleDateInput.value = selectedDateStr;
				titleInput.value = '';
				contentInput.value = '';
				//				animalSelect.value = '';
				modal.style.display = "block";
			};

			window.onclick = e => {
				if (e.target === modal) modal.style.display = "none";
				if (e.target === detailModal) detailModal.style.display = "none";
				if (e.target === memoListModal) memoListModal.style.display = "none";
			};

			memoForm.onsubmit = (e) => {
				// ì²´í¬ëœ ì²´í¬ë°•ìŠ¤ë§Œ ê³¨ë¼ì„œ
				const checkedBoxes = animalCheckboxContainer.querySelectorAll('input[type="checkbox"]:checked');
				const selected = Array.from(checkedBoxes).map(cb => cb.value);
				const joined = selected.join(',');
				document.getElementById('animalNumStr').value = joined;

				memoForm.action = memoNumInput.value ? '/memo/update' : '/memo/add';
				e.preventDefault();

				const url = memoNumInput.value ? '/memo/update' : '/memo/add';
				const formData = new FormData(memoForm);

				fetch(url, {
					method: 'POST',
					body: new URLSearchParams(formData)
				})
					.then(res => {
						if (res.ok) {
							location.href = `/animal/detail?animalNum=${animalNum}&year=${year}&month=${month}`;
						} else {
							alert('ì €ì¥ ì‹¤íŒ¨');
						}
					});
			};

		});
	</script>


</body>

</html>