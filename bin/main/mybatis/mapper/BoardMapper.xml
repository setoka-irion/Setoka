<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.practice.setoka.mapper.BoardMapper">
	
	<!-- 총 게시글 수 -->
	<select id="countAll" resultType="int">
		SELECT COUNT(*) FROM board
	</select>

	<!-- 특정 게시판 전체리스트 -->
	<select id="boardList" resultMap="boardWithUserMap">
		SELECT 
		u.id, u.grade 
		
		
		* FROM board WHERE type= #{type}
	</select>


 	<!-- 글 등록 -->
	<insert id="regist" parameterType="com.practice.setoka.Board">
	INSERT INTO board (userNum, title, content, type, likes, views, price, area, registerDate)
	VALUES (#{userNum}, #{title}, #{content}, #{type}, 0, 0, #{price}, #{area}, NOW())
	</insert>

	<!-- 글 수정 -->
	<update id="update" parameterType="com.practice.setoka.dao.Board">
		UPDATE board
		SET title = #{title}, content = #{content}, 
		price = #{price}, area = #{area}
		WHERE num = #{num}
	</update>
	
	<!-- 글 삭제 (타입을 0번으로 지정)-->
	<update id="delete">
		UPDATE board set type='0' WHERE num = #{num};
	</update> 

	<!-- 조회수 증가 -->
	<update id="addviews" parameterType="int">
		UPDATE board SET views = views + 1 WHERE num = #{num}
	</update>
	
	
	
	
	<!--좋아용 -->
	<update id="increaseLike" parameterType="int">
		UPDATE board SET likes = likes + 1 WHERE num = #{num}
	</update>
	
	<!-- 싫어용 -->
	<update id="decreaseLike" parameterType="int">
		UPDATE board SET likes = likes - 1 WHERE num = #{num}
	</update>




	<!--유저 아이디로 검색 -->
	<select id="listById" parameterType="String" resultType="com.practice.setoka.dto.Board">
		SELECT b.* 	
		FROM board b JOIN users u ON b.userNum = u.num 
		WHERE u.id = #{id}
	</select>

	<!-- 게시글 제목으로 검색 -->
	<select id="listByTitle" parameterType="String" resultType="com.practice.setoka.dto.Board">
		SELECT * FROM board WHERE title = #{title}
	</select>

	<!-- 게시글 내용으로 검색 -->
	<select id="listByContent" parameterType="String" resultType="com.practice.setoka.dto.Board">
		SELECT * FROM board WHERE content = #{content}
	</select>
	
	<!-- 통합 검색 -->
	<select id="searchAll" resultMap="boardWithUserMap">
		SELECT 
		u.id, u.num AS userNum, b.num, b.userNum, b.title, b.content, 
		b.type, b.likes, b.views, b.price, b.area, b.registerDate
		FROM board b JOIN users u ON b.userNum = u.num
		<where>
			b.type != '0'
			<if test="searchType == 'Title'">
				AND b.title LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'content'">
				AND b.content LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'userNum'">
				AND u.id LIKE CONCAT('%', #{keyword}, '%')
			</if>
		</where>
		ORDER BY registerDate DESC
	</select>
	
	
	
 	<!-- 유저 고유번호 이용 특정 유저의 게시글 목록 조회--> 
	<select id="findBoardsByUser" resultMap="boardWithUserMap">
		SELECT u.num AS userNum, u.id, u.nickname, u.realname, u.grade, 
		b.num, b.title,	b.content, b.type, b.likes, b.views, 
		b.price, b.area, b.registerDate
		FROM users u JOIN board b ON u.num = b.userNum
	</select>

	<!-- 위에 두 쿼리 결과 매핑 -->
	<resultMap id="boardWithUserMap" type="com.practice.setoka.BoardWithUserDto">
		<id property="boardId" column="num" />
		<!--user-->
		<result property="userNum" column="userNum" />
		<result property="userId" column="id" />
		<result property="nickname" column="nickname"/>
		<result property="realname" column="realname"/>
		<result property="grade" column="grade"/>
		<!--board-->
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="type" column="type"/>
		<result property="likes" column="likes"/>
		<result property="views" column="views"/>
		<result property="price" column="price"/>
		<result property="area" column="area"/>
		<result property="registerDate" column="registerDate"/>
	</resultMap>

	

</mapper>