<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<title>IRI-ON : 중고거래 게시판</title>
	<link rel="stylesheet" th:href="@{/CSS/header.css}">
	<link rel="stylesheet" th:href="@{/CSS/board.css}">
	<style>

	</style>
</head>

<body>
	<!-- 헤더 -->
	<div th:replace="~{header :: siteHeader}"></div>

	<!-- 컨테이너 -->
	<div class="container-all">
		<!-- 윗단 아이콘 -->
		<div class="board-header">
			<h1><a th:href="@{/UsedGoods}" class="header-link">중고거래 게시판</a></h1>
			<p>총 게시글 수: <span th:text="${totalCount}">0</span></p>
		</div>

		<!-- 윗단 전체 wrapper -->
		<div class="action-row">
			<!-- 검색 wrapper-->
			<div class="center-section">
				<div class="search-button">
					<form th:action="@{/UsedGoods}" method="get" class="search-box">
						<select name="field" class="search-select" th:value="${field}">
							<option value="title" th:selected="${field == 'title'}">제목</option>
							<option value="content" th:selected="${field == 'content'}">내용</option>
							<option value="nickname" th:selected="${field == 'nickname'}">작성자</option>
							<option value="" th:selected="${field == ''}">통합 검색</option>
						</select>
						<input type="text" name="keyword" class="search-input" placeholder="검색어 입력"
							th:value="${keyword}" />
						<button type="submit" class="btn-search">검색</button>
					</form>
				</div>
			</div>

			<!-- 오른쪽 버튼 wrapper -->
			<div class="right-section">

				<!-- 글 등록 버튼 -->
				<div class="regist-button">
					<a th:href="@{/UsedGoodsRegist}" class="btn-primary">새 글 등록하기</a>
				</div>
			</div>
		</div>

		<!-- 한줄 버튼 wrapper-->
		<div class="popular-section">
			<!-- 접기/펼치기 버튼 -->
			<button id="togglePopularBtn" onclick="togglePopular()">
				👁️ 인기글 접기
			</button>
		</div>

		<!--------------------------------------------------------------------------------------------------------------------------->

		<!-- 인기글 타이틀 조정용 wrapper -->
		<div class="main-wrapper">
			<!-- 인기글 타이틀 -->
			<div class="popular-header" style="display:flex; justify-content:space-between; align-items:center;">
				<h3>🔥 인기글</h3>
			</div>
			<!-- 인기글  -->
			<div id="popularContent" class="here"
				style="visibility: visible; height: auto; overflow: hidden; transition: all 0.3s;">
				<div th:each="post, iterStat : ${popularPosts}" th:if="${iterStat.index < 8}" class="card-popular">
					<a th:href="@{'/UsedGoodsDetail/{num}'(num=${post.boardNum}, fromUrl=${request.requestURI} 
					+ '?page=' + ${currentPage} + '&field=' + ${field} + '&keyword=' + ${keyword} + '&viewType=' + ${viewType})}"
						class="link-title">
						<strong th:text="|[${post.area}] ${post.title} 💬(${post.commentCount})|">제목</strong>
					</a>
					<a th:href="@{'/UsedGoodsDetail/{num}'(num=${post.boardNum}, fromUrl=${request.requestURI} 
						+ '?page=' + ${currentPage} + '&field=' + ${field} + '&keyword=' + ${keyword} + '&viewType=' + ${viewType})}">
						<img class="thumb-image"
							th:src="@{${post.Image_paths != null} ? ${post.Image_paths} : '/imagesDefault/defaultBoard.png'}">
					</a>
					<span th:text="'작성자: ' + ${post.nickName}">작성자</span>
					<span
						th:text="'가격: ' + (${post.price != null} ? ${#numbers.formatInteger(post.price, 0, 'COMMA')} : '가격 정보 없음')">가격</span>
					<span th:text="'좋아요: ' + ${post.likes}">좋아요</span>
					<span th:text="'작성일: ' + ${post.formattedRegistDate}">작성일</span>
					<hr>
				</div>
			</div>
		</div>

		<!--------------------------------------------------------------------------------------------------------------------------->
		<!-- 전체 글-->
		<div class="main-container">
			
			<div class="rightsection">
				<div class="main-title">
					<h3>📋전체 글</h3>
				</div>
				<!-- 보기형식 스위치 -->
				<div class="toggle-switch">
					<input type="radio" id="viewCard" name="viewType" value="card" th:checked="${viewType == 'card'}" />
					<label for="viewCard">카드형</label>
					<input type="radio" id="viewList" name="viewType" value="list" th:checked="${viewType == 'list'}" />
					<label for="viewList">리스트형</label>
				</div>
			</div>
			
			<div class="card-container">
				<!-- 카드형 (mainList 반복) -->
				<div class="card-list-view">
					<div class="card-popular" th:each="board, iterStat : ${mainList}">
						<a th:href="@{'/UsedGoodsDetail/{num}'(num=${board.boardNum}, fromUrl=${request.requestURI} + '?page=' + ${currentPage} + '&field=' + ${field} + '&keyword=' + ${keyword} + '&viewType=' + ${viewType})}"
							class="link-title">
							<strong th:text="|[${board.area}] ${board.title} 💬(${board.commentCount})|">제목</strong>
						</a>
						<a th:href="@{'/UsedGoodsDetail/{num}'(num=${board.boardNum})}">
							<img class="thumb-image" th:src="${board.Image_paths}" alt="썸네일" />
						</a>
						<span th:text="'작성자: ' + ${board.nickName}">작성자</span>
						<span
							th:text="'비용: ' + (${board.price != null} ? ${#numbers.formatInteger(board.price, 0, 'COMMA')} : '비용 정보 없음')">비용</span>
						<span th:text="'조회수: ' + ${board.views}">조회수</span>
						<span th:text="'좋아요: ' + ${board.likes}">좋아요</span>
						<span th:text="'작성일: ' + ${board.formattedRegistDate}">작성일</span>
						<hr />
					</div>
					<div th:if="${#lists.isEmpty(mainList)}">등록된 게시글이 없습니다.</div>
				</div>
			</div>

			<div class="list-container">
				<!-- 리스트형 (기존 테이블) -->
				<table class="table-posts">
					<colgroup>
						<col style="width: 5%;" />
						<col style="width: 8%;" />
						<col style="width: 57%;" />
						<col style="width: 5%;" />
						<col style="width: 5%;" />
						<col style="width: 5%;" />
						<col style="width: 5%;" />
						<col style="width: 10%;" />
					</colgroup>
					<thead>
						<tr>
							<th>번호</th>
							<th>작성자</th>
							<th>제목</th>
							<th>가격</th>
							<th>지역</th>
							<th>조회수</th>
							<th>좋아요</th>
							<th>작성일</th>
						</tr>
					</thead>

					<!-- 본문 코드 -->
					<tbody>
						<tr th:each="board, iterStat : ${mainList}">
							<td th:text="${board.boardNum}">1</td>
							<td th:text="${board.nickName}"></td>
							<td>
								<a th:href="@{'/UsedGoodsDetail/{num}'(num=${board.boardNum}, fromUrl=${request.requestURI} + '?page=' + ${currentPage} + '&field=' + ${field} + '&keyword=' + ${keyword} + '&viewType=' + ${viewType})}"
									class="link-title"
									th:text="| [${board.area}] ${board.title} 🗨️(${board.commentCount})|">제목</a>
							</td>
							<td
								th:text="(${board.price != null} ? ${#numbers.formatInteger(board.price, 0, 'COMMA')} : '가격 정보 없음')">
								가격</td>
							<td th:text="${board.area}"></td>
							<td th:text="${board.views}"></td>
							<td th:text="${board.likes}"></td>
							<td th:text="${board.formattedRegistDate}"></td>
						</tr>
						<tr th:if="${#lists.isEmpty(mainList)}">
							<td colspan="9">등록된 게시글이 없습니다.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!--------------------------------------------------------------------------------------------------------------------------->

	<!-- 페이지 네이션-->
	<div class="pagination">
		<!-- 이전 페이지 -->
		<a class="pagination-link" th:if="${currentPage > 1}"
			th:href="@{/UsedGoods(page=${currentPage - 1}, keyword=${keyword}, field=${field}, viewType=${viewType})}">
			◀ 이전
		</a>

		<!-- 숫자 페이지 -->
		<span th:each="pageNum : ${#numbers.sequence(1, totalPages)}">
			<a class="pagination-link"
				th:href="@{/UsedGoods(page=${pageNum}, keyword=${keyword}, field=${field}, viewType=${viewType})}"
				th:text="${pageNum}" th:classappend="${pageNum == currentPage} ? 'active'">
			</a>
		</span>

		<!-- 다음 페이지 버튼 -->
		<a th:if="${currentPage < totalPages}"
			th:href="@{/UsedGoods(page=${currentPage + 1}, keyword=${keyword}, field=${field}, viewType=${viewType})}">
			다음 ▶
		</a>
	</div>

	</div>
	</div>
	<!-- 위로가기 스크롤 버튼 -->
	<div id="scrollTopButton" class="scroll-top-button">
		<a href="#" aria-label="맨 위로">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
				stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
				class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-big-up-lines">
				<path stroke="none" d="M0 0h24v24H0z" fill="none" />
				<path
					d="M9 12h-3.586a1 1 0 0 1 -.707 -1.707l6.586 -6.586a1 1 0 0 1 1.414 0l6.586 6.586a1 1 0 0 1 -.707 1.707h-3.586v3h-6v-3z" />
				<path d="M9 21h6" />
				<path d="M9 18h6" />
			</svg>
		</a>
	</div>
	<script>
		function togglePopular() {
			const section = document.getElementById('popularContent');
			const button = document.getElementById('togglePopularBtn');

			// 현재 상태 확인
			const isHidden = section.style.visibility === 'hidden';

			if (isHidden) {
				// 펼치기
				section.style.visibility = 'visible';
				section.style.height = 'auto';
				button.innerText = '👁️ 인기글 접기';
				sessionStorage.setItem('popularCollapsed', 'false'); // 상태 저장
			} else {
				// 접기
				section.style.visibility = 'hidden';
				section.style.height = '0px';
				button.innerText = '👁️ 인기글 펼치기';
				sessionStorage.setItem('popularCollapsed', 'true'); // 상태 저장
			}
		}

		// 페이지 로드 시 상태 복원
		window.addEventListener('DOMContentLoaded', () => {
			const section = document.getElementById('popularContent');
			const button = document.getElementById('togglePopularBtn');
			const collapsed = sessionStorage.getItem('popularCollapsed');

			if (collapsed === 'true') {
				// 접힌 상태로 복원
				section.style.visibility = 'hidden';
				section.style.height = '0px';
				button.innerText = '👁️ 인기글 펼치기';
			} else {
				// 펼친 상태로 복원
				section.style.visibility = 'visible';
				section.style.height = 'auto';
				button.innerText = '👁️ 인기글 접기';
			}
		});


		// 페이지 로드 시, URL에서 viewType 파라미터 읽어서 라디오 체크와 화면 표시 결정
		function getQueryParam(param) {
			const urlParams = new URLSearchParams(window.location.search);
			return urlParams.get(param);
		}

		function setViewType(viewType) {
			const cardView = document.querySelector('.card-list-view');
			const listView = document.querySelector('.table-posts');
			const radios = document.querySelectorAll('input[name="viewType"]');

			if (viewType === 'list') {
				cardView.classList.add('hidden');
				listView.classList.remove('hidden');
				radios.forEach(r => r.checked = (r.value === 'list'));
			} else {
				cardView.classList.remove('hidden');
				listView.classList.add('hidden');
				radios.forEach(r => r.checked = (r.value === 'card'));
			}
		}

		window.addEventListener('DOMContentLoaded', () => {
			const serverViewType = document.querySelector('input[name="viewType"]:checked')?.value;
			console.log("서버에서 체크된 라디오 값:", serverViewType);

			let viewType = serverViewType || getQueryParam('viewType') || 'card';
			console.log("최종 선택된 viewType:", viewType);

			setViewType(viewType);

			// 라디오 변경 시, 페이지 새로고침하면서 viewType 파라미터 유지
			document.querySelectorAll('input[name="viewType"]').forEach(radio => {
				radio.addEventListener('change', (e) => {
					const params = new URLSearchParams(window.location.search);
					params.set('viewType', e.target.value);
					// 다른 검색 파라미터 유지한 채로 새로고침
					window.location.search = params.toString();
				});
			});
		});

		function setViewType(viewType) {
			const cardContainer = document.querySelector('.card-container');
			const listContainer = document.querySelector('.list-container');
			const mainContainer = document.querySelector('.main-container'); // 새로운 컨테이너 선택

			if (viewType === 'list') {
				cardContainer.style.display = 'none';
				listContainer.style.display = 'block';
				mainContainer.classList.add('list-view-mode');
				mainContainer.classList.remove('card-view-mode');
			} else {
				cardContainer.style.display = 'block';
				listContainer.style.display = 'none';
				mainContainer.classList.add('card-view-mode');
				mainContainer.classList.remove('list-view-mode');
			}
		}

		// 위로가기 버튼
		document.addEventListener('DOMContentLoaded', function () {
			const scrollTopButton = document.getElementById('scrollTopButton');

			window.addEventListener('scroll', function () {
				// 스크롤이 200px 이상 내려갔을 때 버튼을 보이게 함
				if (window.scrollY > 200) {
					scrollTopButton.style.display = 'block';
				} else {
					scrollTopButton.style.display = 'none';
				}
			});

			// 버튼 클릭 시 맨 위로 부드럽게 스크롤
			scrollTopButton.addEventListener('click', function (event) {
				event.preventDefault(); // 기본 링크 동작 방지
				window.scrollTo({
					top: 0,
					behavior: 'smooth'
				});
			});
		});
	</script>

</body>

</html>