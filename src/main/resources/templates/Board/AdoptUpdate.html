<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>입양 게시글 수정</title>
	<meta charset="UTF-8" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<!-- Bootstrap -->
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>

	<!-- Summernote -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-bs4.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-bs4.min.js"></script>

	<!-- 한국어 번역 (선택) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/lang/summernote-ko-KR.min.js"></script>

</head>

<body>
	<h1>입양 게시글 수정</h1>

	<form th:action="@{/AdoptUpdate/{num}(num=${board.boardNum})}" method="post" th:object="${board}"enctype="multipart/form-data">
		<input type="hidden" name="userNum" th:value="${board.userNum}">
		<input type="hidden" name="type" th:value="${board.type}" /> <!-- 어떤게시판인지 알려줘야함-->
		
		<!-- 유효성 검사 오류 메시지 -->
		<div th:if="${#fields.hasErrors('*')}">
			<p th:each="err : ${#fields.errors('*')}" th:text="${err}" style="color:red;"></p>
		</div>

		<label for="title">제목</label><br />
		<input type="text" id="title" th:field="*{title}" placeholder="제목을 입력하세요" required /><br /><br />

		<label for="content">내용</label><br />
		<textarea id="content" th:utext="*{content}" name="content" required></textarea><br /><br />
		
		<!-- 썸네일 기존 이미지 있으면 보여주고 삭제 체크박스 -->
		<div class="form-group" th:if="${board.image_paths != null and !#strings.isEmpty(board.image_paths)}">
			<label>현재 썸네일</label><br />
			<img th:src="@{'/images/' + ${board.image_paths}}" alt="썸네일"
				style="max-width: 200px; display: block; margin-bottom: 10px;" />
			<div class="form-check">
				<input type="checkbox" id="deleteThumbnail" name="deleteThumbnail" value="true" class="form-check-input" />
				<label for="deleteThumbnail" class="form-check-label">썸네일 삭제</label>
			</div>
		</div>
		
		<!-- 썸네일 새로 업로드 가능 -->
		<div class="form-group">
			<label for="images">썸네일 업로드</label>
			<input type="file" id="images" name="images" class="form-control-file" />
		</div>
		
<!--		<div th:if="${board.image_paths}">-->
<!--		    <img th:src="@{'/images/' + ${board.image_paths}}" alt="썸네일" style="max-width: 200px; display:block; margin-bottom:10px;">-->
<!--		    <label>-->
<!--		        <input type="checkbox" name="deleteThumbnail" value="true"> 썸네일 삭제-->
<!--		    </label>-->
<!--		</div>-->
				
		<label for="area">지역</label><br />
		<input type="text" id="area" th:field="*{area}" placeholder="예: 서울, 경기 등" required /><br /><br />

		<label for="price">비용 (무료일 경우 0)</label><br />
		<input type="number" id="price" th:field="*{price}" min="0" placeholder="0" /><br /><br />

		<button type="submit">수정</button>
	</form>

	<p><a th:href="@{/Adopt}">목록으로 돌아가기</a></p>
</body>

<script>
	$(document).ready(function () {
		$('#content').summernote({
			height: 300,
			lang: 'ko-KR',
			placeholder: '입양글의 내용을 입력하세요',
			callbacks: {
				onImageUpload: function (files) {
					for (let i = 0; i < files.length; i++) {
						uploadImage(files[i]);
					}
				}
			}
		});

		let content = $('#content').val();
		$('#content').summernote('code', content);

		function uploadImage(file) {
			const formData = new FormData();
			formData.append("file", file);
			const userNum = document.querySelector('input[name="userNum"]').value;
						formData.append("userNum", userNum);     // 사용자 번호 추가
						
			$.ajax({
				url: '/upload/image', // 이미지 업로드용 컨트롤러
				method: 'POST',
				data: formData,
				processData: false,
				contentType: false,
				success: function (url) {
					$('#content').summernote('insertImage', url);
				},
				error: function () {
					alert('이미지 업로드 실패');
				}
			});
		}
	});
</script>

</html>