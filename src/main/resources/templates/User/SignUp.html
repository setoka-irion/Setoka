<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">

<head>
	<title>IRI-ON : 회원가입</title>
	<link rel="stylesheet" th:href="@{/CSS/header.css}">
	<link rel="stylesheet" th:href="@{/CSS/signUp.css}">
	
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	
</head>

<body>
	<div th:replace="~{header :: siteHeader}"></div>

	<div class="signUp-container">
		<h1>회원가입</h1>
		<form id="signUpForm" th:action="@{/SignUp}" th:object="${Users}" method="post" class="signUp-form">
			<p th:if="${errorMessage}" th:text="${errorMessage}"></p>
			<input type="email" id="email" th:field="*{id}" placeholder="이메일 아이디" required />
			<button type="button" onclick="sendCode()" class="sub-buttons">인증번호 보내기</button>
			<div id="codeBox" class="hidden">
				<input type="text" id="code" placeholder="인증번호 입력" style="flex: 1;">
				<button type="button" onclick="verifyCode()" class="sub-buttons">인증 확인</button>
			</div>
			<input type="password" th:field="*{password}" placeholder="비밀번호" required /><br />
			<input type="password" name="passwordCom" placeholder="비밀번호 확인" required/> <br/>
			<input type="text" th:field="*{nickName}" placeholder="닉네임" required /><br />
			<input type="text" th:field="*{realName}" placeholder="실명" required /><br />
			<input type="tel" th:field="*{phoneNumber}" 
			placeholder="전화번호" 
			required 
			pattern="^\d{3}-\d{3,4}-\d{4}$" 
			maxlength="13"
			inputmode="numeric"/><br />

			<button id="sub" class="sub-buttons hidden" type="button" onclick="submitSignUp()">회원가입</button>
		</form>
	</div>
	
</body>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const phoneInput = document.querySelector('[name="phoneNumber"]');

    phoneInput.addEventListener("input", function (e) {
      let value = e.target.value.replace(/[^0-9]/g, ''); // 숫자만 남기기

      if (value.length <= 3) {
        // 010
        e.target.value = value;
      } else if (value.length <= 7) {
        // 010-1234
        e.target.value = value.slice(0, 3) + '-' + value.slice(3);
      } else if (value.length <= 11) {
        // 010-1234-5678
        e.target.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7);
      } else {
        // 최대 11자리까지만
        e.target.value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
      }
    });
  });
</script>
</html>


<script>
	
	const csrfToken = document.querySelector('meta[name="_csrf"]').content;
	const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
	const headers = new Headers();
			headers.append('Content-Type', 'application/json');
			headers.append(csrfHeader, csrfToken);

	function sendCode() {
		const email = document.getElementById('email').value;
		if (!email.includes('@')) {
			alert('유효한 이메일을 입력하세요.');
			return;
		}

		
		fetch('/sendSingUpCode', {
			method: 'POST',
			headers: headers,
			body: JSON.stringify({email: email})
		})
			.then(response => response.text().then(text => {
				if (response.ok) {
					alert('인증번호가 이메일로 전송되었습니다.');
					document.getElementById('codeBox').style.display = 'flex';
				} else {
					alert(text);
				}
			}));
	}

	function verifyCode() {
		const email = document.getElementById('email').value;
		if (!email.includes('@')) {
			alert('유효하지 않은 이메일 형식');
			return;
		}
		const code = document.getElementById('code').value;
		if (!code) {
		    alert('인증번호를 입력하세요.');
		    return;
		}
		
		if (!/^\d+$/.test(code)) {
		       alert('인증번호는 숫자만 입력해야 합니다.');
		       return;
		}

		fetch('/verifySingUpCode', {
			method: 'POST',
			headers: headers,
			body: JSON.stringify({email: email, code: code})
		})
			.then(response => {
				if (response.ok) {
					alert('인증번호 맞음');
					document.getElementById('sub').style.display = 'block';
				}
				else {
					alert('인증번호 틀림');
				}
			})
	}

</script>

<script>
	function submitSignUp() {
		const form = document.getElementById('signUpForm');
		const formData = new FormData(form);

		// FormData를 JSON으로 변환 (passwordCom 제외)
		const jsonObject = {};
		let passwordComValue = null;

		formData.forEach((value, key) => {
			if (key === 'passwordCom') {
				passwordComValue = value; // passwordCom은 따로 뺌
			} else {
				jsonObject[key] = value;
			}
		});

		// URL에 passwordCom 쿼리 파라미터 추가 (인코딩 주의)
		const url = '/SignUp?passwordCom=' + encodeURIComponent(passwordComValue);

		fetch(url, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				[csrfHeader]: csrfToken
			},
			body: JSON.stringify(jsonObject)
		})
		.then(res => {
			if (res.ok) {
				alert("🎉 회원가입이 완료되었습니다!");
				window.location.href = "/";  // 홈페이지로 이동
			} else {
				return res.text().then(text => alert(text));
			}
		})
		.catch(error => {
			console.error(error);
			alert("오류가 발생했습니다.");
		});
	}

</script>