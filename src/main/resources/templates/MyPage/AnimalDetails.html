<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8" />
	<title>애견 상세보기 + 달력</title>
	<link rel="stylesheet" th:href="@{/CSS/header.css}">
	<link rel="stylesheet" th:href="@{/CSS/user.css}">
	<link rel="stylesheet" th:href="@{/CSS/modal.css}">
	<link rel="stylesheet" th:href="@{/CSS/calendar.css}">
	<link rel="stylesheet" th:href="@{/CSS/nav-buttons.css}">
	<link rel="stylesheet" th:href="@{/CSS/memo-list.css}">

	<style>
		.memo-title {
			font-size: 0.75em;
			color: #007bff;
			margin-top: 5px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			display: block;
		}


		button {
			margin: 0 10px;
			padding: 5px 15px;
		}

		#memoModal,
		#memoListModal,
		#memoDetailModal {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.4);
		}

		#memoModalContent,
		#memoListModal>div,
		#memoDetailModal>div {
			background: white;
			margin: 10% auto;
			padding: 20px;
			width: 350px;
			border-radius: 5px;
			position: relative;
			max-height: 70vh;
			overflow-y: auto;
		}

		#memoModalContent label,
		#memoModalContent input[type="text"],
		#memoModalContent textarea,
		#memoModalContent select {
			display: block;
			width: 100%;
			margin-top: 10px;
			padding: 5px;
		}

		#memoModalClose,
		#memoListClose,
		#memoDetailClose {
			position: absolute;
			right: 10px;
			top: 10px;
			cursor: pointer;
			font-weight: bold;
			font-size: 18px;
		}

		.blank {
			background: #f9f9f9;
			cursor: default;
		}
	</style>
</head>

<body>
	<div th:replace="~{header :: siteHeader}"></div>

	<!-- 애견 상세정보 -->
	<h1 th:text="${CurrentAnimal.animalName} + ' 상세정보'" style="text-align: center;">애견 이름 상세정보</h1>

	<div class="animal-card">
		<div class="user-card-left">
			<img th:if="${CurrentAnimal.profilePath != null and CurrentAnimal.profilePath != ''}"
				th:src="@{{filename}(filename=${CurrentAnimal.profilePath})}" alt="프로필 사진"
				class="profile-image" />

			<p th:if="${CurrentAnimal.profilePath == null or CurrentAnimal.profilePath == ''}">프로필 사진이 없습니다.</p>

		</div>

		<div class="user-card-right">
			<ul class="user-info-list">
				
				<li><strong>이름</strong> <span th:text="${CurrentAnimal.animalName}">이름</span></li>
				<li><strong>종</strong> <span th:text="${CurrentAnimal.species}">종</span></li>
				<li><strong>나이</strong> <span th:text="${CurrentAnimal.age}">나이</span></li>
				<li><strong>함께한 날</strong> <span th:text="${CurrentAnimal.togetherDateLong}">함께한 날</span></li>
				<li><strong>성별</strong> <span th:text="${CurrentAnimal.gender}">성별</span></li>
			</ul>
			<div class="animal-buttons">
				<button onclick="location.href='/myanimal'">애견 목록으로</button>
			</div>
		</div>
	</div>



	<!-- 달력 네비게이션 -->
	<div class="nav-buttons">
		<form th:action="@{/animal/detail}" method="get" style="display:inline;">
			<input type="hidden" name="animalNum" th:value="${CurrentAnimal.num}" />
			<input type="hidden" name="year" th:value="${month == 1} ? ${year - 1} : ${year}" />
			<input type="hidden" name="month" th:value="${month == 1} ? 12 : ${month - 1}" />
			<button type="submit">◀</button>
		</form>

		<span id="yearMonth" th:attr="data-year=${year}, data-month=${month}"
			th:text="${year} + '년 ' + ${month} + '월'"></span>

		<form th:action="@{/animal/detail}" method="get" style="display:inline;">
			<input type="hidden" name="animalNum" th:value="${CurrentAnimal.num}" />
			<input type="hidden" name="year" th:value="${month == 12} ? ${year + 1} : ${year}" />
			<input type="hidden" name="month" th:value="${month == 12} ? 1 : ${month + 1}" />
			<button type="submit">▶</button>
		</form>
	</div>

	<!-- 달력 테이블 -->
	<table id="calendar">
		<thead>
			<tr>
				<th>일</th>
				<th>월</th>
				<th>화</th>
				<th>수</th>
				<th>목</th>
				<th>금</th>
				<th>토</th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="weekRow : ${#numbers.sequence(0, weekCount - 1)}">
				<td th:each="dayIdx : ${#numbers.sequence(0,6)}"
					th:classappend="${((weekRow * 7) + dayIdx + 1 - startBlank <= 0 or (weekRow * 7) + dayIdx + 1 - startBlank > lengthOfMonth) ? 'blank' : ''}"
					th:attr="data-date=${(weekRow * 7) + dayIdx + 1 - startBlank > 0 and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth} ? ${year + '-' + (month < 10 ? '0' + month : month) + '-' + (((weekRow * 7) + dayIdx + 1 - startBlank) < 10 ? '0' + ((weekRow * 7) + dayIdx + 1 - startBlank) : ((weekRow * 7) + dayIdx + 1 - startBlank))} : ''">

					<span
						th:if="${(weekRow * 7) + dayIdx + 1 - startBlank > 0 and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth}"
						th:text="${(weekRow * 7) + dayIdx + 1 - startBlank}"></span>
				</td>
			</tr>
		</tbody>
	</table>

	<!-- 메모 모달 -->
	<div id="memoModal">
		<div id="memoModalContent">
			<span id="memoModalClose">&times;</span>
			<h2 id="modalTitle" class="modal-title">메모 작성</h2>

			<form id="memoForm" method="post" th:action="@{/memo/add}">

				<input type="hidden" name="userNum" th:value="${userNum}" />
				<!-- 기존 animalNum 히든 필드 제거 -->
				<input type="hidden" id="memoNum" name="num" value="" />

				<div class="form-group">
					<label for="scheduleDate">작성일</label>
					<input type="text" id="scheduleDate" name="scheduleDateStr" readonly />
				</div>
				<hr />

				<div class="form-group">
					<label for="animalSelect">애견 선택</label>
					<div id="animalCheckboxContainer"></div>
					<input type="hidden" id="animalNumStr" name="animalNumStr" />
				</div>
				<hr />

				<div class="form-group">
					<label for="title">제목</label>
					<input type="text" id="title" name="title" required />
				</div>
				<hr />

				<div class="form-group">
					<label for="content">내용</label>
					<textarea id="content" name="content" rows="5" required></textarea>
				</div>
				<hr />

				<div class="modal-buttons">
					<button type="submit" id="saveBtn" class="btn">저장</button>
				</div>
			</form>
		</div>
	</div>

	<!-- 리스트 모달 -->

	<div id="memoListModal" class="modal-overlay">
		<div class="modal-content">
			<span id="memoListClose" class="modal-close">&times;</span>
			<h2 class="modal-title">메모 리스트</h2>
			<ul id="memoListContainer" style="list-style:none; padding:0; margin:0;"></ul>

			<div class="modal-buttons">
				<button id="memoListAddBtn" class="btn">메모 추가</button>
			</div>
		</div>
	</div>
	<!-- 상세보기 모달 -->

	<div id="memoDetailModal" class="modal-overlay">
		<div class="modal-content">
			<span id="memoDetailClose" class="modal-close">&times;</span>
			<h2 class="modal-title">메모 상세보기</h2>

			<div class="detail-row">
				<span class="label">날짜</span>
				<span id="detailDate" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">애견 이름</span>
				<span id="detailAnimalName" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">제목</span>
				<span id="detailTitleText" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">내용</span>
				<div id="detailContent" class="content-box"></div>
			</div>

			<div class="modal-buttons">
				<button id="detailAddBtn" class="btn">추가</button>
				<button id="detailBackToListBtn" class="btn" style="display: none;">목록</button>
				<button id="detailEditBtn" class="btn">수정</button>
				<button id="detailDeleteBtn" class="btn btn-danger">삭제</button>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		const animalNum = /*[[${animalNum}]]*/ 0;
		const userNum = /*[[${userNum}]]*/ 0;
		/*]]>*/
	</script>

	<script>
		let selectedDateStr = null;
		let lastMemoList = [];

		document.addEventListener('DOMContentLoaded', () => {
			const modal = document.getElementById('memoModal');
			const modalClose = document.getElementById('memoModalClose');
			const scheduleDateInput = document.getElementById('scheduleDate');
			const titleInput = document.getElementById('title');
			const contentInput = document.getElementById('content');
			const memoNumInput = document.getElementById('memoNum');
			const memoForm = document.getElementById('memoForm');
			const modalTitle = document.getElementById('modalTitle');
			const saveBtn = document.getElementById('saveBtn');
			const animalCheckboxContainer = document.getElementById('animalCheckboxContainer');

			const detailModal = document.getElementById('memoDetailModal');
			const detailClose = document.getElementById('memoDetailClose');
			const detailDate = document.getElementById('detailDate');
			const detailTitleText = document.getElementById('detailTitleText');
			const detailContent = document.getElementById('detailContent');
			const detailEditBtn = document.getElementById('detailEditBtn');
			const detailDeleteBtn = document.getElementById('detailDeleteBtn');
			const detailAddBtn = document.getElementById('detailAddBtn');
			const detailAnimalName = document.getElementById('detailAnimalName');

			const memoListModal = document.getElementById('memoListModal');
			const memoListClose = document.getElementById('memoListClose');
			const memoListContainer = document.getElementById('memoListContainer');
			const memoListAddBtn = document.getElementById('memoListAddBtn');

			const yearMonthSpan = document.getElementById('yearMonth');
			const year = parseInt(yearMonthSpan.dataset.year);
			const month = parseInt(yearMonthSpan.dataset.month);

			let animalMap = new Map();
			let currentDetailMemoNum = null;

			// ✅ 해당 애견만 등록


			// 1. 동물 목록 먼저 불러오기
			fetch(`/animals`)
				.then(res => res.json())
				.then(animals => {
					animals.forEach(animal => {
						animalMap.set(animal.num, animal.animalName);

						const label = document.createElement('label');
						label.style.display = 'block';

						const checkbox = document.createElement('input');
						checkbox.type = 'checkbox';
						checkbox.name = 'animalNum';
						checkbox.value = animal.num;

						label.appendChild(checkbox);
						label.appendChild(document.createTextNode(' ' + animal.animalName));
						animalCheckboxContainer.appendChild(label);
					});

					// ✅ 2. 동물 다 처리한 다음에 메모 불러오기
					return fetch(`/memos?year=${year}&month=${month < 10 ? '0' + month : month}`);
				})
				.then(res => res.json())
				.then(memos => {
					const filteredMemos = memos.filter(memo => {return memo.intAnimalNum != null && memo.intAnimalNum.includes(Number(animalNum));});
					const memoMap = {};

					filteredMemos.forEach(memo => {
						const dateOnly = memo.scheduleDate.split('T')[0];
						if (!memoMap[dateOnly]) memoMap[dateOnly] = [];

						if (Array.isArray(memo.intAnimalNum)) {
							const names = memo.intAnimalNum.map(num => animalMap.get(num));
							memo.animalName = names.join(', ');
						} else {
							memo.animalName = animalMap.get(memo.intAnimalNum);
						}
						memoMap[dateOnly].push(memo);
					});

					Object.keys(memoMap).forEach(date => {
						const td = document.querySelector(`td[data-date='${date}']`);
						if (td) {
							td.querySelectorAll('.memo-title').forEach(el => el.remove());
							memoMap[date].forEach(m => {
								const span = document.createElement('span');
								span.className = 'memo-title';
								span.textContent = m.title;
								td.appendChild(span);
							});
							td.dataset.memoList = JSON.stringify(memoMap[date]);
						}
					});

					document.querySelectorAll('#calendar td').forEach(td => {
						td.addEventListener('click', () => {
							const dateStr = td.getAttribute('data-date');
							selectedDateStr = dateStr;
							if (!dateStr) return;

							const memoListStr = td.dataset.memoList;
							let memoList = [];

							if (memoListStr) {
								try {
									memoList = JSON.parse(memoListStr);
								} catch (e) {
									console.error('메모 리스트 JSON 파싱 실패', e);
								}
							}

							if (memoList.length === 0) {
								detailModal.style.display = 'none';
								modalTitle.textContent = "메모 작성";
								saveBtn.textContent = "저장";

								memoNumInput.value = '';
								scheduleDateInput.value = dateStr;
								titleInput.value = '';
								contentInput.value = '';

								modal.style.display = "block";

							} else if (memoList.length === 1) {
								showDetailModal(memoList[0], dateStr);

							} else {
								memoListContainer.innerHTML = '';

								memoList.forEach(memo => {
									const li = document.createElement('li');
									li.style.cursor = 'pointer';
									li.style.padding = '5px 0';
									li.style.borderBottom = '1px solid #ddd';

									li.innerHTML = `
																			<div class="memo-list-item">
																				<div class="memo-title">${memo.title}</div>
																				<div class="memo-animal">🐾 ${memo.animalName || '애견없음'}</div>
																			</div>
																		`;
									li.addEventListener('click', () => {
										memoListModal.style.display = 'none';

										lastMemoList = memoList;

										showDetailModal(memo, dateStr);
									});

									memoListContainer.appendChild(li);
								});

								memoListModal.style.display = 'block';
							}
						});
					});
				});

			function showDetailModal(memo, dateStr) {
				currentDetailMemoNum = memo.num || memo.memoNum;

				detailDate.textContent = dateStr;
				detailTitleText.textContent = memo.title;
				detailContent.textContent = memo.content;
				detailAnimalName.textContent = memo.animalName || '알 수 없음';

				const backToListBtn = document.getElementById('detailBackToListBtn');
				if (lastMemoList.length > 1) {
					backToListBtn.style.display = 'inline-block';
				} else {
					backToListBtn.style.display = 'none';
				}

				backToListBtn.onclick = () => {
					detailModal.style.display = 'none';
					document.getElementById('memoListModal').style.display = 'block';
				};

				detailEditBtn.onclick = () => {
					detailModal.style.display = 'none';
					modalTitle.textContent = "메모 수정";
					saveBtn.textContent = "수정";

					memoNumInput.value = currentDetailMemoNum;
					scheduleDateInput.value = dateStr;
					titleInput.value = memo.title;
					contentInput.value = memo.content;
					// 체크박스 선택 처리
					const selectedAnimals = memo.intAnimalNum || memo.animalNum || []; // 배열 형태라고 가정

					// 체크박스 모두 언체크 후,
					animalCheckboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
						cb.checked = selectedAnimals.includes(Number(cb.value));
					});
					modal.style.display = "block";
				};

				detailDeleteBtn.onclick = () => {
					if (confirm("정말 삭제하시겠습니까?")) {
						const formData = new URLSearchParams();
						formData.append('num', currentDetailMemoNum);
						formData.append('year', year);
						formData.append('month', month);

						fetch('/memo/delete', {
							method: 'POST',
							headers: {'Content-Type': 'application/x-www-form-urlencoded'},
							body: formData.toString()
						}).then(() => {
							detailModal.style.display = 'none';
							location.href = `/animal/detail?animalNum=${animalNum}&year=${year}&month=${month}`;
						});
					}
				};

				detailAddBtn.onclick = () => {
					detailModal.style.display = 'none';
					modalTitle.textContent = "메모 작성";
					saveBtn.textContent = "저장";

					memoNumInput.value = '';
					scheduleDateInput.value = dateStr;
					titleInput.value = '';
					contentInput.value = '';
					//					animalSelect.value = '';
					modal.style.display = "block";
				};

				detailModal.style.display = "block";
			}

			modalClose.onclick = () => modal.style.display = "none";
			detailClose.onclick = () => detailModal.style.display = "none";
			memoListClose.onclick = () => memoListModal.style.display = "none";
			memoListAddBtn.onclick = () => {
				memoListModal.style.display = "none";
				modalTitle.textContent = "메모 작성";
				saveBtn.textContent = "저장";
				memoNumInput.value = '';
				scheduleDateInput.value = selectedDateStr;
				titleInput.value = '';
				contentInput.value = '';
				//				animalSelect.value = '';
				modal.style.display = "block";
			};

			window.onclick = e => {
				if (e.target === modal) modal.style.display = "none";
				if (e.target === detailModal) detailModal.style.display = "none";
				if (e.target === memoListModal) memoListModal.style.display = "none";
			};

			memoForm.onsubmit = (e) => {
				// 체크된 체크박스만 골라서
				const checkedBoxes = animalCheckboxContainer.querySelectorAll('input[type="checkbox"]:checked');
				const selected = Array.from(checkedBoxes).map(cb => cb.value);
				const joined = selected.join(',');
				document.getElementById('animalNumStr').value = joined;

				memoForm.action = memoNumInput.value ? '/memo/update' : '/memo/add';
				e.preventDefault();

				const url = memoNumInput.value ? '/memo/update' : '/memo/add';
				const formData = new FormData(memoForm);

				fetch(url, {
					method: 'POST',
					body: new URLSearchParams(formData)
				})
					.then(res => {
						if (res.ok) {
							location.href = `/animal/detail?animalNum=${animalNum}&year=${year}&month=${month}`;
						} else {
							alert('저장 실패');
						}
					});
			};

		});
	</script>


</body>

</html>