<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">

<head>
	<title>MyPage</title>
	<link rel="stylesheet" th:href="@{/CSS/header.css}">
	<link rel="stylesheet" th:href="@{/CSS/user.css}">
	<link rel="stylesheet" th:href="@{/CSS/modal.css}">
	<link rel="stylesheet" th:href="@{/CSS/calendar.css}">
	<link rel="stylesheet" th:href="@{/CSS/nav-buttons.css}">
	<link rel="stylesheet" th:href="@{/CSS/memo-list.css}">

	<style>
		#memoModal {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.4);
		}

		#memoModalContent {
			background: white;
			margin: 10% auto;
			padding: 20px;
			width: 350px;
			border-radius: 5px;
			position: relative;
		}

		#memoModalContent label {
			display: block;
			margin-top: 10px;
		}

		#memoModalContent input[type="text"],
		#memoModalContent textarea,
		#memoModalContent select {
			width: 100%;
			padding: 5px;
			margin-top: 5px;
		}

		#memoModalClose {
			position: absolute;
			right: 10px;
			top: 10px;
			cursor: pointer;
			font-weight: bold;
			font-size: 18px;
		}

		.blank {
			background: #f9f9f9;
			cursor: default;
		}
	</style>
</head>

<body>
	<div th:replace="~{header :: siteHeader}"></div>

	<div class="user-card">
		<div class="user-buttons">
		   <button onclick="location.href='/MessageList'">ìª½ì§€í•¨</button>
		   <button onclick="location.href='/ModifyUser'">ê°œì¸ì •ë³´ ìˆ˜ì •</button>
		   <button onclick="location.href='/ChangePassword'">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
		   <button onclick="location.href='/Withdrawal'">íšŒì›íƒˆí‡´</button>
		 </div>
		
		<div class="user-card-container">
			<div class="user-card-left">
				<a href="/EditProfilePhoto">
					<img th:src="@{${loginUser.profilePath}}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-image">
				</a>
			</div>
			<div class="user-card-right">
				<ul class="user-info-list">
					<li><strong>ë‹‰ë„¤ì„</strong> <span th:text="${loginUser.nickName}">ë‹‰ë„¤ì„</span></li>
					<li><strong>ì‹¤ëª…</strong> <span th:text="${loginUser.realName}">ì‹¤ëª…</span></li>
					<li><strong>ë“±ê¸‰</strong> <span th:text="${loginUser.grade}">ë“±ê¸‰</span></li>
					<li><strong>í¬ì¸íŠ¸</strong> <span th:text="${loginUser.point}">í¬ì¸íŠ¸</span></li>
					<li><strong>ê²½í—˜ì¹˜</strong> <span th:text="${loginUser.exp}">ê²½í—˜ì¹˜</span></li>
				</ul>
			</div>
		</div>
		
	</div>

	<!--ì¼ì • ë‹¬ë ¥-->
	<div class="nav-buttons" style="display: flex; align-items: center; gap: 10px; justify-content: center;">
		<form th:action="@{/MyPage}" method="get" style="display:inline;">
			<input type="hidden" name="year" th:value="${month == 1} ? ${year - 1} : ${year}" />
			<input type="hidden" name="month" th:value="${month == 1} ? 12 : ${month - 1}" />
			<button type="submit">â—€</button>
		</form>

		<span id="yearMonth" th:attr="data-year=${year}, data-month=${month}"
			th:text="${year} + 'ë…„ ' + ${month} + 'ì›”'"></span>

		<form th:action="@{/MyPage}" method="get" style="display:inline;">
			<input type="hidden" name="year" th:value="${month == 12} ? ${year + 1} : ${year}" />
			<input type="hidden" name="month" th:value="${month == 12} ? 1 : ${month + 1}" />
			<button type="submit">â–¶</button>
		</form>
	</div>

	<table id="calendar">
		<thead>
			<tr>
				<th>ì¼</th>
				<th>ì›”</th>
				<th>í™”</th>
				<th>ìˆ˜</th>
				<th>ëª©</th>
				<th>ê¸ˆ</th>
				<th>í† </th>
			</tr>
		</thead>

		<tbody>
			<tr th:each="weekRow : ${#numbers.sequence(0, weekCount - 1)}">
				<td th:each="dayIdx : ${#numbers.sequence(0,6)}" th:classappend="${((weekRow * 7) + dayIdx + 1 - startBlank <= 0 
	                           or (weekRow * 7) + dayIdx + 1 - startBlank > lengthOfMonth) ? 'blank' : ''}"
					th:attr="data-date=${(weekRow * 7) + dayIdx + 1 - startBlank > 0 and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth} ?
	                       ${year + '-' + (month < 10 ? '0' + month : month) + '-' + (((weekRow * 7) + dayIdx + 1 - startBlank) < 10 ? '0' + ((weekRow * 7) + dayIdx + 1 - startBlank) : ((weekRow * 7) + dayIdx + 1 - startBlank))} : ''">

					<span th:if="${(weekRow * 7) + dayIdx + 1 - startBlank > 0 
	                     and (weekRow * 7) + dayIdx + 1 - startBlank <= lengthOfMonth}"
						th:text="${(weekRow * 7) + dayIdx + 1 - startBlank}"></span>

				</td>
			</tr>
		</tbody>
	</table>

	<!-- ë©”ëª¨ ëª¨ë‹¬ (ìˆ˜ì • ëª¨ë‹¬) -->
	<div id="memoModal" class="modal-overlay">
		<div class="modal-content">

			<span id="memoModalClose" class="modal-close">&times;</span>
			<h2 id="modalTitle" class="modal-title">ë©”ëª¨ ì‘ì„±</h2>

			<form id="memoForm" method="post" th:action="@{/memo/add}">

				<input type="hidden" name="userNum" th:value="${userNum}" />
				<!-- ê¸°ì¡´ animalNum íˆë“  í•„ë“œ ì œê±° -->
				<input type="hidden" id="memoNum" name="num" value="" />

				<div class="form-group">
					<label for="scheduleDate">ì‘ì„±ì¼</label>
					<input type="text" id="scheduleDate" name="scheduleDateStr" readonly />
				</div>
				<hr />

				<div class="form-group">
					<label for="animalSelect">ì• ê²¬ ì„ íƒ</label>
					<div id="animalCheckboxContainer"></div>
					<input type="hidden" id="animalNumStr" name="animalNumStr" />
				</div>
				<hr />

				<div class="form-group">
					<label for="title">ì œëª©</label>
					<input type="text" id="title" name="title" required />
				</div>
				<hr />

				<div class="form-group">
					<label for="content">ë‚´ìš©</label>
					<textarea id="content" name="content" rows="5" required></textarea>
				</div>
				<hr />

				<div class="modal-buttons">
					<button type="submit" id="saveBtn" class="btn">ì €ì¥</button>
				</div>
			</form>
		</div>
	</div>

	<!-- ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
	<div id="memoListModal" class="modal-overlay">
		<div class="modal-content">
			<span id="memoListClose" class="modal-close">&times;</span>
			<h2 class="modal-title">ë©”ëª¨ ë¦¬ìŠ¤íŠ¸</h2>
			<ul id="memoListContainer" style="list-style:none; padding:0; margin:0;"></ul>

			<div class="modal-buttons">
				<button id="memoListAddBtn" class="btn">ë©”ëª¨ ì¶”ê°€</button>
			</div>
		</div>
	</div>

	<!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
	<div id="memoDetailModal" class="modal-overlay">
		<div class="modal-content">
			<span id="memoDetailClose" class="modal-close">&times;</span>
			<h2 class="modal-title">ë©”ëª¨ ìƒì„¸ë³´ê¸°</h2>

			<div class="detail-row">
				<span class="label">ë‚ ì§œ</span>
				<span id="detailDate" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">ì• ê²¬ ì´ë¦„</span>
				<span id="detailAnimalName" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">ì œëª©</span>
				<span id="detailTitleText" class="value"></span>
			</div>
			<hr />

			<div class="detail-row">
				<span class="label">ë‚´ìš©</span>
				<div id="detailContent" class="content-box"></div>
			</div>

			<div class="modal-buttons">
				<button id="detailAddBtn" class="btn">ì¶”ê°€</button>
				<button id="detailBackToListBtn" class="btn" style="display: none;">ëª©ë¡</button>
				<button id="detailEditBtn" class="btn">ìˆ˜ì •</button>
				<button id="detailDeleteBtn" class="btn btn-danger">ì‚­ì œ</button>
			</div>
		</div>
	</div>


	<script>
		// 1. ìœ ì €ì˜ ì• ë‹ˆë©€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ animalNum â†’ animalName ë§¤í•‘ ìƒì„±
		let animalMap = new Map();
		let currentDetailMemoNum;

		let selectedDateStr = null;
		let lastMemoList = [];

		document.addEventListener('DOMContentLoaded', () => {
			const modal = document.getElementById('memoModal');
			const modalClose = document.getElementById('memoModalClose');
			const scheduleDateInput = document.getElementById('scheduleDate');
			const titleInput = document.getElementById('title');
			const contentInput = document.getElementById('content');
			const memoNumInput = document.getElementById('memoNum');
			const memoForm = document.getElementById('memoForm');
			const modalTitle = document.getElementById('modalTitle');
			const saveBtn = document.getElementById('saveBtn');
			const animalCheckboxContainer = document.getElementById('animalCheckboxContainer');

			const detailModal = document.getElementById('memoDetailModal');
			const detailClose = document.getElementById('memoDetailClose');
			const detailDate = document.getElementById('detailDate');
			const detailTitleText = document.getElementById('detailTitleText');
			const detailContent = document.getElementById('detailContent');
			const detailEditBtn = document.getElementById('detailEditBtn');
			const detailDeleteBtn = document.getElementById('detailDeleteBtn');
			const detailAddBtn = document.getElementById('detailAddBtn');
			const detailAnimalName = document.getElementById('detailAnimalName');

			const yearMonthSpan = document.getElementById('yearMonth');
			const year = yearMonthSpan.dataset.year;
			const month = yearMonthSpan.dataset.month;

			const userNum = document.querySelector('input[name="userNum"]').value;


			fetch(`/animals`)
				.then(res => res.json())
				.then(animals => {
					animals.forEach(animal => {
						animalMap.set(animal.num, animal.animalName);

						// ì²´í¬ë°•ìŠ¤ ìƒì„±
						const label = document.createElement('label');
						label.style.display = 'block';  // ì¤„ë°”ê¿ˆ íš¨ê³¼

						const checkbox = document.createElement('input');
						checkbox.type = 'checkbox';
						checkbox.name = 'animalNum'; // ë°°ì—´í˜•íƒœë¡œ ì„œë²„ì—ì„œ ë°›ìœ¼ë ¤ë©´ 'animalNum' or 'animalNum[]' ë‘˜ ë‹¤ ê°€ëŠ¥
						checkbox.value = animal.num;

						label.appendChild(checkbox);
						label.appendChild(document.createTextNode(animal.animalName));

						animalCheckboxContainer.appendChild(label);
					});
					// 2) ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
					return fetch(`/memos?year=${year}&month=${month < 10 ? '0' + month : month}`);
				})
				.then(res => res.json())
				.then(memos => {
					const memoMap = {};

					memos.forEach(memo => {
						const dateOnly = memo.scheduleDate.split('T')[0];
						if (!memoMap[dateOnly]) memoMap[dateOnly] = [];

						// animalNum ìœ¼ë¡œ animalName ë§¤í•‘í•´ì„œ ì¶”ê°€
						if (Array.isArray(memo.intAnimalNum)) {
							const names = memo.intAnimalNum.map(num => animalMap.get(num) || 'ì• ê²¬ì—†ìŒ');
							memo.animalName = names.join(', ');
						} else if (memo.intAnimalNum) {
							memo.animalName = animalMap.get(memo.intAnimalNum) || 'ì• ê²¬ì—†ìŒ';
						} else {
							memo.animalName = 'ì• ê²¬ì—†ìŒ';
						}


						memoMap[dateOnly].push(memo);
					});

					Object.keys(memoMap).forEach(date => {
						const td = document.querySelector(`td[data-date='${date}']`);
						if (td) {
							td.querySelectorAll('.memo-title').forEach(el => el.remove());

							memoMap[date].forEach(m => {
								const span = document.createElement('span');
								span.className = 'memo-title';
								span.textContent = m.title;
								td.appendChild(span);
							});

							td.dataset.memoList = JSON.stringify(memoMap[date]);
						}
					});

					// 3) ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
					document.querySelectorAll('#calendar td').forEach(td => {
						td.addEventListener('click', () => {
							const dateStr = td.getAttribute('data-date');
							selectedDateStr = dateStr;
							if (!dateStr) return;

							const memoListStr = td.dataset.memoList;
							let memoList = [];

							if (memoListStr) {
								try {
									memoList = JSON.parse(memoListStr);
								} catch (e) {
									console.error('ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ JSON íŒŒì‹± ì‹¤íŒ¨', e);
								}
							}

							if (memoList.length === 0) {
								// ë©”ëª¨ ì—†ìŒ -> ì‘ì„± ëª¨ë‹¬
								detailModal.style.display = 'none';
								modalTitle.textContent = "ë©”ëª¨ ì‘ì„±";
								saveBtn.textContent = "ì €ì¥";

								memoNumInput.value = '';
								scheduleDateInput.value = dateStr;
								titleInput.value = '';
								contentInput.value = '';

								modal.style.display = "block";

							} else if (memoList.length === 1) {
								// ë©”ëª¨ 1ê°œ -> ìƒì„¸ë³´ê¸° ëª¨ë‹¬ + ë²„íŠ¼ í•¸ë“¤ëŸ¬ ì„¸íŒ…
								showDetailModal(memoList[0], dateStr);

							} else {
								// ë©”ëª¨ 2ê°œ ì´ìƒ -> ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬
								const memoListModal = document.getElementById('memoListModal');
								const memoListContainer = document.getElementById('memoListContainer');

								memoListContainer.innerHTML = '';

								memoList.forEach(memo => {
									const li = document.createElement('li');
									li.style.cursor = 'pointer';
									li.style.padding = '5px 0';
									li.style.borderBottom = '1px solid #ddd';

									li.innerHTML = `
										<div class="memo-list-item">
											<div class="memo-title">${memo.title}</div>
											<div class="memo-animal">ğŸ¾ ${memo.animalName || 'ì• ê²¬ì—†ìŒ'}</div>
										</div>
									`;

									li.addEventListener('click', () => {
										memoListModal.style.display = 'none';

										lastMemoList = memoList;

										showDetailModal(memo, dateStr);
									});

									memoListContainer.appendChild(li);
								});

								// ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
								document.getElementById('memoListClose').onclick = () => {
									memoListModal.style.display = 'none';
								};

								// ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ ë‚´ ë©”ëª¨ ì¶”ê°€ ë²„íŠ¼
								document.getElementById('memoListAddBtn').onclick = () => {
									memoListModal.style.display = 'none';

									modalTitle.textContent = "ë©”ëª¨ ì‘ì„±";
									saveBtn.textContent = "ì €ì¥";

									memoNumInput.value = '';
									scheduleDateInput.value = dateStr;
									titleInput.value = '';
									contentInput.value = '';

									modal.style.display = "block";
								};

								memoListModal.style.display = 'block';
							}
						});
					});
				});

			// ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ì—´ê¸° ë° ë²„íŠ¼ í•¸ë“¤ëŸ¬ ì„¸íŒ… í•¨ìˆ˜
			function showDetailModal(memo, dateStr) {
				currentDetailMemoNum = memo.num || memo.memoNum;

				detailDate.textContent = dateStr;
				detailTitleText.textContent = memo.title;
				detailContent.textContent = memo.content;
				detailAnimalName.textContent = memo.animalName || 'ì•Œ ìˆ˜ ì—†ìŒ';

				const backToListBtn = document.getElementById('detailBackToListBtn');
				if (lastMemoList.length > 1) {
					backToListBtn.style.display = 'inline-block';  // ë³´ì—¬ì¤Œ
				} else {
					backToListBtn.style.display = 'none';  // ìˆ¨ê¹€
				}

				backToListBtn.onclick = () => {
					detailModal.style.display = 'none';
					document.getElementById('memoListModal').style.display = 'block';
				};

				detailEditBtn.onclick = () => {
					detailModal.style.display = 'none';
					modalTitle.textContent = "ë©”ëª¨ ìˆ˜ì •";
					saveBtn.textContent = "ìˆ˜ì •";

					memoNumInput.value = currentDetailMemoNum;
					scheduleDateInput.value = dateStr;
					titleInput.value = memo.title;
					contentInput.value = memo.content;

					const checkboxes = document.querySelectorAll('#animalCheckboxContainer input[type="checkbox"]');
					checkboxes.forEach(cb => cb.checked = false);

					if (memo.intAnimalNum && Array.isArray(memo.intAnimalNum)) {
						memo.intAnimalNum.forEach(num => {
							const cb = document.querySelector(`#animalCheckboxContainer input[type="checkbox"][value="${num}"]`);
							if (cb) cb.checked = true;
						});
					} else if (memo.intAnimalNum) {
						const cb = document.querySelector(`#animalCheckboxContainer input[type="checkbox"][value="${memo.intAnimalNum}"]`);
						if (cb) cb.checked = true;
					}

					modal.style.display = "block";
				};

				detailDeleteBtn.onclick = () => {
					if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
						const formData = new URLSearchParams();
						formData.append('num', currentDetailMemoNum);
						formData.append('year', year);
						formData.append('month', month);

						fetch('/memo/delete', {
							method: 'POST',
							headers: {'Content-Type': 'application/x-www-form-urlencoded'},
							body: formData.toString()
						}).then(() => {
							detailModal.style.display = 'none';
							location.href = `/MyPage?year=${year}&month=${month}`;
						});
					}
				};

				detailAddBtn.onclick = () => {
					detailModal.style.display = 'none';
					modalTitle.textContent = "ë©”ëª¨ ì‘ì„±";
					saveBtn.textContent = "ì €ì¥";

					memoNumInput.value = '';
					scheduleDateInput.value = selectedDateStr;
					titleInput.value = '';
					contentInput.value = '';
					modal.style.display = "block";
				};

				detailModal.style.display = 'block';
			}

			modalClose.onclick = () => modal.style.display = "none";
			detailClose.onclick = () => detailModal.style.display = "none";

			window.onclick = e => {
				if (e.target === modal) modal.style.display = "none";
				if (e.target === detailModal) detailModal.style.display = "none";
			};
			memoForm.onsubmit = () => {
				const selected = Array.from(document.querySelectorAll('#animalCheckboxContainer input[type="checkbox"]:checked'))
					.map(cb => cb.value);
				const joined = selected.join(',');
				document.getElementById('animalNumStr').value = joined;

				memoForm.action = memoNumInput.value ? '/memo/update' : '/memo/add';
			};
		});
	</script>
</body>

</html>