<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" th:inline="javascript">

<head>
	<meta charset="UTF-8" />
	<title>My Animal Page</title>
	<link rel="stylesheet" th:href="@{/CSS/header.css}">
	<link rel="stylesheet" th:href="@{/CSS/animalPage.css}">
</head>

<body>
	<div th:replace="~{header :: siteHeader}"></div>

	<h1 style="text-align:center;">내 동물 목록</h1>

	<div class="animalPage">
	<!-- 동물이 없으면 추가 폼만 보여줌 -->
	<div th:if="${#lists.isEmpty(animalList)}" style="width: 400px; margin: auto;">
		<h3>등록된 동물이 없습니다. 동물을 추가하세요.</h3>
		<form th:action="@{/myanimal/add}" method="post" enctype="multipart/form-data">
			<label>프로필 사진: <input type="file" name="profileImage" accept="image/*" /></label><br /><br />
			<label>이름: <input type="text" name="animalName" required /></label><br /><br />
			<label>종: <input type="text" name="species" required /></label><br /><br />
			<label>나이: <input type="number" name="age" min="0" required /></label><br /><br />
			<label>성별:</label><br />
			<label>
				<input type="radio" name="gender" value="수컷" id="editMale" /> 수컷
			</label>
			<label>
				<input type="radio" name="gender" value="암컷" id="editFemale" /> 암컷
			</label><br /><br />
			<input type="hidden" name="status" value="정상" id="editStatus">
			<label>입양일: <input type="date" name="togetherDateStr" required /></label><br /><br />
			<button type="submit">추가하기</button>
		</form>
	</div>

	<div style="text-align: center;">
		<!-- 동물이 있는 경우 -->
		<div th:if="${!#lists.isEmpty(animalList)}" 
			style="display: flex; max-width: 100%;
			 margin: auto; 
			 border-radius: 10px; 
			 border: 1px solid rgb(0, 0, 0);
			  box-shadow: 0 0 5px #333;
			  align-items: center;
			   overflow-x: auto;">
	
			<!--  -->
			<div class="scroll-container" style="display: flex; overflow-x: auto; gap: 16px; padding: 10px; justify-content: flex-start;">
				<div th:each="animal : ${animalList}" th:attr="onclick='location.href=\'/animal/detail?animalNum=' + ${animal.num} + '\''" style="min-width: 300px; flex-shrink: 0; border: 1px solid rgb(255, 255, 255);
					 border-radius: 8px; padding: 12px; box-shadow: 0 0 5px rgba(0,0,0,0.1);
					 background-color: rgb(198, 184, 166);">
	
					<div
						style="text-align: center; margin-bottom: 10px; width: 280px; height: 300px; margin-left: auto; margin-right: auto; display: flex; align-items: center; justify-content: center; border-radius: 10%; background-color: rgb(255, 255, 255);">
						<img th:if="${animal.profilePath != null}"
							th:src="@{{filename}(filename=${animal.profilePath})}" alt="프로필"
							style="width: 280px; height: 300px; object-fit: cover; border-radius: 10%;" />
					</div>
	
					<div style="font-weight: bold; font-size: 1.1em; margin-bottom: 6px;">
						<span th:text="${animal.animalName}"></span>
					</div>
	
					<div><strong>종:</strong> <span th:text="${animal.species}"></span></div>
					<div><strong>나이:</strong> <span th:text="${animal.age}"></span></div>
					<div><strong>성별:</strong> <span th:text="${animal.gender}"></span></div>
					<div><strong>함께한 날:</strong> <span th:text="${animal.togetherDateLong}"></span></div>
	
					<div style="margin-top: 10px; display: flex; justify-content: space-between;">
						<button type="button" th:onclick="'event.stopPropagation(); openEditModal(' + ${animal.num} + ')'"
							style="padding: 4px 8px;">수정</button>
	
						<form th:action="@{/myanimal/delete}" method="post" onsubmit="event.stopPropagation(); return confirm('삭제하시겠습니까?');"
							style="margin:0;">
							<input type="hidden" name="animalNum" th:value="${animal.num}" />
							<button type="submit" onclick="event.stopPropagation();" style="padding: 4px 8px;">삭제</button>
						</form>
					</div>
				</div>
				
				<!-- 빈 카드 추가 -->
				<div class="emptycard" style="min-width: 300px; flex-shrink: 0; border: 1px dashed gray; 
				border-radius: 8px; padding: 12px; box-shadow: 0 0 5px rgba(0,0,0,0.05);
				 background-color: #f5f5f5; display: flex; align-items: center; justify-content: center;">
				    <!-- 빈 카드 안에 들어갈 내용 예: 아이콘이나 텍스트 -->
					<button type="button" onclick="openAddModal()">+</button>
				</div>
				
			</div>
		</div>
	</div>
	
	<!-- 모달 오버레이 -->
	<div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>

	<!-- 추가 모달 -->
	<div id="addModal" class="modal">
		<h2>동물 추가</h2>
		<form id="addForm" th:action="@{/myanimal/add}" method="post" enctype="multipart/form-data">
			<label>프로필 사진: <input type="file" name="profileImage" accept="image/*" /></label><br /><br />
			<label>이름: <input type="text" name="animalName" required /></label><br /><br />
			<label>종: <input type="text" name="species" required /></label><br /><br />
			<label>나이: <input type="number" name="age" min="0" required /></label><br /><br />
			<label>성별:</label><br />
			<label>
				<input type="radio" name="gender" value="수컷" /> 수컷
			</label>
			<label>
				<input type="radio" name="gender" value="암컷" /> 암컷
			</label><br /><br />
			<input type="hidden" name="status" value="정상" />
			<label>입양일: <input type="date" name="togetherDateStr" required /></label><br /><br />
			<button type="submit">추가하기</button>
			<button type="button" onclick="closeModal()">취소</button>
		</form>
	</div>

	<!-- 수정 모달 -->
	<div id="editModal" class="modal">
		<h2>동물 수정</h2>
		<form id="editForm" enctype="multipart/form-data">
			<input type="hidden" name="animalNum" id="editAnimalNum" />
			<input type="hidden" name="existingProfilePath" id="editExistingProfilePath" />
			<label>프로필 사진: <input type="file" name="profileImage" id="editProfileImage"
					accept="image/*" /></label>
			<label>이름: <input type="text" name="animalName" id="editAnimalName" required /></label>
			<label>종: <input type="text" name="species" id="editSpecies" required /></label>
			<label>나이: <input type="number" name="age" id="editAge" min="0" required /></label>
			<label>성별:</label>
			<label>
				<input type="radio" name="gender" value="수컷" id="editMale" /> 수컷
			</label>
			<label>
				<input type="radio" name="gender" value="암컷" id="editFemale" /> 암컷
			</label>
			<label>상태:
				<select name="status" id="editStatus" required>
					<option value="정상">정상</option>
					<option value="사망">사망</option>
				</select>
			</label>
			<label>입양일: <input type="date" name="togetherDateStr" id="editTogetherDate" required /></label>
			<button type="button" onclick="submitEdit()">수정하기</button>
			<button type="button" onclick="closeModal()">취소</button>
		</form>
	</div>

	</div>
	<script>
		const modalOverlay = document.getElementById('modalOverlay');
		const addModal = document.getElementById('addModal');
		const editModal = document.getElementById('editModal');

		function openAddModal() {
			addModal.classList.add('active');
			modalOverlay.classList.add('active');
		}

		function openEditModal(animalNum) {
			fetch(`/myanimal/edit?animalNum=${animalNum}`)
				.then(res => res.json())
				.then(data => {
					document.getElementById('editAnimalNum').value = data.num;
					document.getElementById('editAnimalName').value = data.animalName;
					document.getElementById('editSpecies').value = data.species;
					document.getElementById('editAge').value = data.age;
					if (data.gender == '수컷') {
						document.getElementById('editMale').checked = true;
					} else if (data.gender == '암컷') {
						document.getElementById('editFemale').checked = true;
					}
					document.getElementById('editStatus').value = data.status;
					document.getElementById('editTogetherDate').value = data.togetherDate ? data.togetherDate.substr(0, 10) : '';
					document.getElementById('editExistingProfilePath').value = data.profilePath || '';
					editModal.classList.add('active');
					modalOverlay.classList.add('active');
				})
				.catch(() => alert('데이터를 불러오는 중 오류가 발생했습니다.'));
		}

		function closeModal() {
			addModal.classList.remove('active');
			editModal.classList.remove('active');
			modalOverlay.classList.remove('active');
		}

		function submitEdit() {
			const form = document.getElementById('editForm');
			const formData = new FormData(form);
			const animalNum = formData.get('animalNum');

			fetch(`/myanimal/edit`, {
				method: 'POST',
				body: formData,
			})
				.then(res => res.text())
				.then(text => {
					if (text === 'success') {
						alert('수정이 완료되었습니다.');
						location.reload();
					} else {
						alert('수정 실패');
					}
				})
				.catch(() => alert('서버 오류'));
		}
	</script>
	
	<script>
		const scrollContainer = document.querySelector('.scroll-container');

		scrollContainer.addEventListener('wheel', function (e) {
			if (e.deltaY !== 0) {
				e.preventDefault();
				this.scrollLeft += e.deltaY;
			}
		}, { passive: false }); // preventDefault를 허용하려면 passive: false 필수
	</script>

</body>

</html>